<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>UDP Networking for Multiplayer | Metric Panda Games</title><meta name=description content="This week has been dedicated to more multiplayer development for Rival Fortress.I’ve fleshed out a networking model based on the one described in the original Tribes paper with ..."><meta name=keywords><meta property=og:title content="UDP Networking for Multiplayer | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="UDP Networking for Multiplayer"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="This week has been dedicated to more multiplayer development for Rival Fortress.I’ve fleshed out a networking model based on the one described in the original Tribes paper with ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="UDP Networking for Multiplayer"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>UDP Networking for Multiplayer</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #19</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>This week has been dedicated to <a href=/rival-fortress-update-18-multiplayer-decisions/index.html>more multiplayer</a> development for <a href=/rival-fortress/index.html>Rival Fortress</a>.</p><p>I’ve fleshed out a networking model based on the one described in the original <a href=http://gamedevs.org/uploads/tribes-networking-model.pdf>Tribes</a> paper with a few twists of my own.</p><p>The model is built on top of the <a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol>User Datagram Protocol</a>(UDP), a very flexible and simple protocol that, is one of the most common choices when it comes to online multiplayer games (the other being the <a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>Transmission Control Protocol</a>(TCP)).</p><p>UDP, unlike it’s “bigger brother” TCP, is an unreliable protocol, meaning that when sending a packet to a destination computer there is no guarantee or notification of delivery. This may look like a downside, but as <a href=https://twitter.com/gafferongames>Glenn Fiedler</a> explains very well in his post <a href="http://gafferongames.com/networking-for-game-programmers/udp-vs-tcp/">UDP vs. TCP</a>, UDP is the ideal protocol for most games because it provides the flexibility needed for responsive online multiplayer.</p><h2 id=ideal-packet-size>Ideal packet size</h2><p>Optimal networking code, among other things, tends to be about cramming <em>as much information as possible into the least possible space</em>. This is because, although you can theoretically construct UDP packets as large as <a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol#Packet_structure>65,535 bytes</a>, the ideal size is dependent on the <a href=https://en.wikipedia.org/wiki/Maximum_transmission_unit>Maximum transmission unit</a>(MTU) of the Internet that is around 1500-bytes per packet.</p><p>Packets larger than this will cause routers to split your packet into multiple parts (<a href=https://en.wikipedia.org/wiki/IP_fragmentation>packet fragmentation</a>), complicating things for you.</p><h2 id=optimal-network-replication>Optimal Network replication</h2><p>Packet size constraints require a smart approach to serializing game objects for replication. You can’t just naïvely <code class=highlighter-rouge>memcpy</code> your objects into UDP datagrams and hope for the best; most of the time you will be sending bloated data over the wire, when you could have serialized only relevant bits. For example sending 4 bytes for an integer that only needs 5 bits to represent it’s full range used in the game it’s rather wasteful, it may not seem like much in isolation, but it can add up pretty quickly over the course of a multiplayer session.</p><p>There are many ways to approach compact object serialization and replication, but the ideal way depends on the type of game you are building and the type of data you need to send over the wire. Take a look at the excellent <a href="http://gafferongames.com/building-a-game-network-protocol/">Building a Game Network Protocol</a> series for a primer on how to go about implementing your own solution.</p><h2 id=networking-code-generation>Networking code generation</h2><p>For Rival Fortress I extended the <a href=/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html>reflection system</a> of the engine to generate most of the serialization and replication code.</p><p>For example the following snippet of code represents a message sent by the client to initiate a connection to the server:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=n>MREFLECT</span><span class=p>(</span><span class=n>NetworkMessage</span><span class=p>,</span> <span class=n>Reliability</span><span class=o>=</span><span class=n>Guaranteed</span><span class=p>,</span> <span class=n>Priority</span><span class=o>=</span><span class=n>High</span><span class=p>)</span>
<span class=k>struct</span> <span class=n>MPEConnectionRequestMessage</span>
<span class=p>{</span>
  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>NetworkValue</span><span class=p>,</span> <span class=n>Size</span><span class=o>=</span><span class=n>NameLength</span><span class=p>)</span>
  <span class=kt>char</span> <span class=n>Name</span><span class=p>[</span><span class=n>MPE_NETWORK_MAX_NAME_LENGTH</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>

  <span class=n>MPEVersion</span> <span class=n>Version</span><span class=p>;</span>

  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>NetworkValue</span><span class=p>,</span> <span class=n>Size</span><span class=o>=</span><span class=mi>5</span><span class=n>bits</span><span class=p>)</span>
  <span class=n>u32</span> <span class=n>NameLength</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure><p>As you can see, the <code class=highlighter-rouge>struct</code> is annotated with a no-op <code class=highlighter-rouge>MREFLECT</code> macro that gets parsed by the reflection preprocessor. In this case the engine will generate the code to send a <em>guaranteed</em> packet (i.e. it will retry up to a maximum amount of times until a confirmation reply is received from the destination) with a <em>high priority</em> (i.e. it will prioritize this message when constructing the packet over others with lower priority).</p><p>Also, you can see that the <code class=highlighter-rouge>struct</code> members are annotated to indicate how much space they should occupy in the final UDP packet: 5 bits for the <code class=highlighter-rouge>NameLength</code> and <code class=highlighter-rouge>NameLength</code> for the <code class=highlighter-rouge>Name</code> string.</p><p>Every struct like this generates a <em>send</em>/<em>receive</em> pair of functions that handle the serialization and deserialization.</p><p>The engine tries to pool multiple messages into a single UDP packet until the packet size is reached or a timer threshold is surpassed (10 milliseconds) in order to not waste bandwidth on packet overhead.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #19: UDP Networking for Multiplayer&amp;url=https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-19-reliable-udp-for-multiplayer/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>