<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Avoiding Automatic Structure Padding in C | Metric Panda Games</title><meta name=description content="Note: This post is x86 centric. On other architectures your mileage may vary.Compiling with the -Wpadded flag on GCC/Clang or -we4820 -we4121 on MSVC, warns you when the compile..."><meta name=keywords><meta property=og:title content="Avoiding Automatic Structure Padding in C | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/"><meta property=og:image content=https://metricpanda.comalignment.png><meta name=twitter:title content="Avoiding Automatic Structure Padding in C"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Note: This post is x86 centric. On other architectures your mileage may vary.Compiling with the -Wpadded flag on GCC/Clang or -we4820 -we4121 on MSVC, warns you when the compile..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/"><meta name=twitter:image content=https://metricpanda.comalignment.png><meta name=twitter:image:alt content="Avoiding Automatic Structure Padding in C"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Avoiding Automatic Structure Padding in C</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #35</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p class=note><b>Note</b>: This post is x86 centric. On other architectures your mileage may vary.</p><p>Compiling with the <code class=highlighter-rouge>-Wpadded</code> flag on GCC/Clang or <code class=highlighter-rouge>-we4820 -we4121</code> on MSVC, warns you when the compiler inserts padding in your <code class=highlighter-rouge>structs</code>.</p><p>These warnings are off by default, because in most circumstances automatic padding is quite convenient, but if you are writing high performance code or embedded systems, padding explicitly and trying to avoid padding may be the better choice.</p><h2 id=why-compiler-padding-is-a-thing>Why compiler padding is a thing</h2><p>Compilers insert padding to keep <a href=https://en.wikipedia.org/wiki/Data_structure_alignment>data structures aligned</a>, thus avoiding misaligned reads and making memory access faster.</p><p>The rules for when compilers insert padding depend on the target architecture’s <a href=https://en.wikipedia.org/wiki/Word_(computer_architecture)>word</a> size and the size of each member field in relation to the following member as explained on “<a href=https://en.wikipedia.org/wiki/Data_structure_alignment#Typical_alignment_of_C_structs_on_x86>Typical alignment of C structs on x86</a>”.</p><p>If the structure contains members with explicit alignment (i.e. types declared with <code class=highlighter-rouge>__attribute__((aligned(n)))</code> on GCC/Clang or <code class=highlighter-rouge>__declspec(align(n))</code> on MSVC), then the compiler will take that in consideration when padding.</p><h2 id=examples-of-automatic-padding>Examples of automatic padding</h2><p>Take the following structure:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>typedef</span> <span class=k>struct</span> <span class=n>Paddee</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=n>X</span><span class=p>;</span> <span class=c1>// 1 byte</span>
  <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>  <span class=c1>// 4 bytes</span>
<span class=p>}</span> <span class=n>Paddee</span><span class=p>;</span></code></pre></figure><p>It is compiled on x86_64 into an <em>equivalent</em> of the following:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>typedef</span> <span class=k>struct</span> <span class=n>Paddee</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=n>X</span><span class=p>;</span>                    <span class=c1>// 1 byte</span>
  <span class=kt>char</span> <span class=n>_COMPILER_PADDING</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span> <span class=c1>// 3 bytes (invisible)</span>
  <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>                     <span class=c1>// 4 bytes</span>
<span class=p>}</span> <span class=n>Paddee</span><span class=p>;</span></code></pre></figure><p>The member field <code class=highlighter-rouge>_COMPILER_PADDING</code> is not really there, but it is as if it was there, because the compiler inserted the 3 bytes of padding between <code class=highlighter-rouge>X</code> and <code class=highlighter-rouge>Y</code>. If you compile the struct yourself and check <code class=highlighter-rouge>sizeof(Paddee)</code> you will see that it is 8 bytes, not 5.</p><p>The padding is also added at the tail end of the <code class=highlighter-rouge>struct</code>, so if you rearrange the members the compiler will pad like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>typedef</span> <span class=k>struct</span> <span class=n>Paddee</span>
<span class=p>{</span>
  <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>                     <span class=c1>// 4 bytes</span>
  <span class=kt>char</span> <span class=n>X</span><span class=p>;</span>                    <span class=c1>// 1 byte</span>
  <span class=kt>char</span> <span class=n>_COMPILER_PADDING</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span> <span class=c1>// 3 bytes (invisible)</span>
<span class=p>}</span> <span class=n>Paddee</span><span class=p>;</span></code></pre></figure><p>For a more realistic example, in the game engine for <a href=/rival-fortress/index.html>Rival Fortress</a> I have a 4x4 matrix type that looks something like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=n>MS_ALIGN</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span> <span class=k>typedef</span> <span class=k>union</span> <span class=n>MPEMatrix4</span>
<span class=p>{</span>
  <span class=k>struct</span>
  <span class=p>{</span>
    <span class=n>MPEVec4</span> <span class=n>Col1</span><span class=p>;</span>
    <span class=n>MPEVec4</span> <span class=n>Col2</span><span class=p>;</span>
    <span class=n>MPEVec4</span> <span class=n>Col3</span><span class=p>;</span>
    <span class=n>MPEVec4</span> <span class=n>Col4</span><span class=p>;</span>
  <span class=p>};</span>
  <span class=k>struct</span>
  <span class=p>{</span>
    <span class=n>SIMDVec</span> <span class=n>SIMDCol1</span><span class=p>;</span>
    <span class=n>SIMDVec</span> <span class=n>SIMDCol2</span><span class=p>;</span>
    <span class=n>SIMDVec</span> <span class=n>SIMDCol3</span><span class=p>;</span>
    <span class=n>SIMDVec</span> <span class=n>SIMDCol4</span><span class=p>;</span>
  <span class=p>};</span>
  <span class=n>MPEVec4</span> <span class=n>VecColumns</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
  <span class=n>SIMDVec</span> <span class=n>SIMDColumns</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
  <span class=n>f32</span> <span class=n>Flat</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
<span class=p>}</span> <span class=n>MPEMatrix4</span> <span class=nf>GCC_ALIGN</span><span class=p>(</span><span class=mi>16</span><span class=p>);</span></code></pre></figure><p>The <code class=highlighter-rouge>MS_ALIGN</code> and <code class=highlighter-rouge>GCC_ALIGN</code> expand to <a href=https://gcc.gnu.org/onlinedocs/gcc-4.0.2/gcc/Type-Attributes.html>GCC/Clang</a> or <a href=https://msdn.microsoft.com/en-us/library/83ythb65.aspx>MSVC</a> alignment macros. They tell the compiler that this type should always be aligned to 16 byte boundaries (in order to play nice with SSE instructions).</p><p>Because of the forced alignment constraint every other type that includes <code class=highlighter-rouge>MPEMatrix4</code> as a member will inherit its alignment requirement. For example, the following dummy type:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=n>MPEExample</span>
<span class=p>{</span>
  <span class=n>MPEMatrix4</span> <span class=n>Model</span><span class=p>;</span> <span class=c1>// 16 bytes</span>
  <span class=n>u32</span> <span class=n>Flags</span><span class=p>;</span>        <span class=c1>// 4 bytes</span>
  <span class=n>u8</span> <span class=n>_PADDING</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>  <span class=c1>// 12 bytes</span>
<span class=p>};</span></code></pre></figure><p>Requires 12 bytes of padding(!) in order to be properly aligned. This translates into a lot of wasted memory bandwidth when dealing with arrays with thousands of entries, like for example entities in a game.</p><p>The solution, in an extreme case like this, is to either rethink the <code class=highlighter-rouge>MPEExample</code> and move the <code class=highlighter-rouge>Flags</code> field somewhere else (maybe a parallel array that you loop through before or after), or fill the 12 empty bytes with useful data in order to eliminate the wasted memory.</p><h2 id=tips-for-eliminating-compiler-padding>Tips for eliminating compiler padding</h2><p>You avoid automatic padding by making the compiler happy and aligning your structures optimally. The <code class=highlighter-rouge>-Wpadded</code> compiler flag is your guide in knowing when a structure needs better alignment.</p><p>The common ways to align structures manually are:</p><ul><li><strong>Rearrange fields</strong>: reorder the field in order to maximize packing. I don’t know about GCC and MSVC, but Clang warns you about misaligned fields, so you know where the problem is.</li><li><strong>Group small types</strong>: grouping <code class=highlighter-rouge>char</code>s, <code class=highlighter-rouge>short</code>s and <code class=highlighter-rouge>int</code>s after larger types, like pointers, can lead to better alignment.</li><li><strong>Use smaller/bigger types</strong>: when possible choose different primitive types, like a <code class=highlighter-rouge>uint16_t</code> instead of an <code class=highlighter-rouge>int</code>, or a <code class=highlighter-rouge>size_t</code> instead of an <code class=highlighter-rouge>uint32_t</code>. You can then tie this back to the previous tip about grouping small types.</li><li><strong>Insert dummy fields</strong>: the last resort is to insert fields in your <code class=highlighter-rouge>structs</code> between members that require alignment or at the end of the <code class=highlighter-rouge>struct</code>. This is what the compiler does, but by doing yourself you have a reminder that you can act on when you modify the <code class=highlighter-rouge>struct</code>. I usually add a byte array named <code class=highlighter-rouge>_PADDING</code> of the size required to reach alignment.</li></ul><p>Keep in mind that for large structures, cache line size becomes relevant, so try not to not break groups of fields that you want pulled into the same cache line when restructuring your <code class=highlighter-rouge>structs</code>.</p><p>The excellent post <a href="http://www.catb.org/esr/structure-packing/">The Lost Art of C Structure Packing</a> goes in detail on how to optimally pack structures in C.</p><h2 id=what-to-do-when-you-cant-align-but-dont-want-padding>What to do when you can’t align, but don’t want padding</h2><p>Padding is not always a good thing. For example when serializing data types to disk or over the network, it is often better to keep structures tightly packed even if it causes unaligned memory reads.</p><p>To selectively disable padding you can use the <code class=highlighter-rouge>#pragma pack</code> directive like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#pragma pack(push, 1)
</span><span class=k>struct</span> <span class=n>MPEExample</span>
<span class=p>{</span>
  <span class=n>MPEMatrix4</span> <span class=n>Model</span><span class=p>;</span> <span class=c1>// 16 bytes</span>
  <span class=n>u32</span> <span class=n>Flags</span><span class=p>;</span>        <span class=c1>// 4 bytes</span>
  <span class=c1>// No padding</span>
<span class=p>};</span>
<span class=cp>#pragma pack(pop)</span></code></pre></figure><p>This will disable compiler padding and keep <code class=highlighter-rouge>sizeof(MPEExample)</code> equal to the sum of the sizes of its members (in this case 20 bytes, instead of 32).</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #35: Avoiding Automatic Structure Padding in C&amp;url=https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>