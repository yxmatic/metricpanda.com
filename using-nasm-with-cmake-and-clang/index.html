<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Using NASM with CMake and Clang | Metric Panda Games</title><meta name=description content="Trying to integrate NASM with CMake for the build system of Rival Fortress has been tricky.The documentation on the official wiki is not up to date, and in fact, states that NAS..."><meta name=keywords><meta property=og:title content="Using NASM with CMake and Clang | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/using-nasm-with-cmake-and-clang/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Using NASM with CMake and Clang"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Trying to integrate NASM with CMake for the build system of Rival Fortress has been tricky.The documentation on the official wiki is not up to date, and in fact, states that NAS..."><meta name=twitter:url content="https://metricpanda.com/using-nasm-with-cmake-and-clang/"><meta name=twitter:url content="https://metricpanda.com/using-nasm-with-cmake-and-clang/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Using NASM with CMake and Clang"><link rel=canonical href="https://metricpanda.com/using-nasm-with-cmake-and-clang/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Using NASM with CMake and Clang</h1><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/other.html>Other</a></p></header><div class=post-content><p>Trying to integrate NASM with CMake for the build system of <a href=/rival-fortress/index.html>Rival Fortress</a> has been tricky. The documentation on the <a href=https://cmake.org/Wiki/CMake/Assembler>official wiki</a> is not up to date, and in fact, states that NASM is not supported by CMake 2.6 and below, but fortunately after a little bit of digging through <a href=https://github.com/Kitware/CMake>CMake’s source</a> I found that NASM is indeed supported since CMake version 2.8.</p><h2 id=using-nasm-with-cmake>Using NASM with CMake</h2><p>To enable support for <code class=highlighter-rouge>.asm</code> source files in your project you have to make sure you add the <code class=highlighter-rouge>C</code> language flag to your project declaration in your <code class=highlighter-rouge>CMakeLists.txt</code> file like so:</p><figure class=highlight><pre><code class=language-cmake data-lang=cmake><span class=nb>project</span><span class=p>(</span>RivalFortress C CXX<span class=p>)</span></code></pre></figure><p>Rival Fortress is in C++, but the <code class=highlighter-rouge>C</code> specification is required otherwise the CMake variable <code class=highlighter-rouge>CMAKE_C_SIZEOF_DATA_PTR</code> will not be set. This variable is read by the <a href=https://github.com/Kitware/CMake/blob/master/Modules/CMakeASM_NASMInformation.cmake>NASM CMake module</a> during initialization and used by CMake to detect processor architecture (32/64bit) and determines the <code class=highlighter-rouge>-f</code> flag that will be passed to NASM during compilation.</p><p>Next, in order to enable <code class=highlighter-rouge>*.asm</code> compilation, you must enable the <code class=highlighter-rouge>ASM_NASM</code> language like so:</p><figure class=highlight><pre><code class=language-cmake data-lang=cmake><span class=nb>enable_language</span><span class=p>(</span>ASM_NASM<span class=p>)</span>
<span class=nb>if</span><span class=p>(</span>CMAKE_ASM_NASM_COMPILER_LOADED<span class=p>)</span>
  <span class=nb>set</span><span class=p>(</span>CAN_USE_ASSEMBLER TRUE<span class=p>)</span>
  <span class=nb>file</span><span class=p>(</span>GLOB_RECURSE ENGINE_ASM_FILES <span class=s2>"src/engine/*.asm"</span><span class=p>)</span>
  <span class=nb>set</span><span class=p>(</span>ENGINE_SOURCES <span class=si>${</span><span class=nv>ENGINE_SOURCES</span><span class=si>}</span> <span class=si>${</span><span class=nv>ENGINE_ASM_FILES</span><span class=si>}</span><span class=p>)</span>
<span class=nb>endif</span><span class=p>(</span>CMAKE_ASM_NASM_COMPILER_LOADED<span class=p>)</span></code></pre></figure><p>This snippet of code attempts to load the <code class=highlighter-rouge>ASM_NASM</code> language compiler and checks if it has been loaded correctly. If load was successful, the <code class=highlighter-rouge>CAN_USE_ASSEMBLER</code> variable is set to <code class=highlighter-rouge>TRUE</code> and all <code class=highlighter-rouge>*.asm</code> files are globbed and added to the source files to be compiles.</p><p>Later in the <code class=highlighter-rouge>CMakeLists.txt</code> you can check if assembly is supported for the current build using the <code class=highlighter-rouge>CAN_USE_ASSEMBLER</code> variable and branch like so:</p><figure class=highlight><pre><code class=language-cmake data-lang=cmake><span class=nb>if</span><span class=p>(</span>NOT CAN_USE_ASSEMBLER<span class=p>)</span>
   <span class=nb>set</span><span class=p>(</span>ENGINE_SOURCES <span class=si>${</span><span class=nv>ENGINE_SOURCES</span><span class=si>}</span> codec_generic.cpp<span class=p>)</span>
<span class=nb>endif</span><span class=p>(</span>NOT CAN_USE_ASSEMBLER<span class=p>)</span></code></pre></figure><p>Now CMake will automatically call NASM during compilation to generate object files that will be linked with other object files generated by clang.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Using NASM with CMake and Clang&amp;url=https://metricpanda.com/using-nasm-with-cmake-and-clang/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/using-nasm-with-cmake-and-clang/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>