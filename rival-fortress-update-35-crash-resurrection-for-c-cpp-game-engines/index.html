<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Simple Crash Resurrection For C/C++ Game Engines | Metric Panda Games</title><meta name=description content="The video demonstrates the crash resurrection functionality in Metric Panda Engine. A simple feature that, by using the engine&#39;s hot reloading functionality, reloads a previous ..."><meta name=keywords><meta property=og:title content="Simple Crash Resurrection For C/C++ Game Engines | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/"><meta property=og:image content=https://metricpanda.comcrash-resurrection.png><meta name=twitter:title content="Simple Crash Resurrection For C/C++ Game Engines"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="The video demonstrates the crash resurrection functionality in Metric Panda Engine. A simple feature that, by using the engine&#39;s hot reloading functionality, reloads a previous ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/"><meta name=twitter:image content=https://metricpanda.comcrash-resurrection.png><meta name=twitter:image:alt content="Simple Crash Resurrection For C/C++ Game Engines"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Simple Crash Resurrection For C/C++ Game Engines</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #36</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>The video demonstrates the <strong>crash resurrection</strong> functionality in <em>Metric Panda Engine</em>.</p><figure class="media-wrapper page-media" style=max-width:1012px><div class="js-media-player media-player" data-media=crash-resurrection data-format=wide data-loop=false style=padding-bottom:42.687747035573125%;background-image:url(https://www.metricpanda.com/crash-resurrection/wide.png);><div class=media-player-placeholder><i class="icon icon-play"></i></div></div><figcaption>Crash resurrection of Metric Panda Engine<a href=/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/index.html title="Rival Fortress Update #36: Simple Crash Resurrection For C/C++ Game Engines">Read More</a> <a href=/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/index.html title="Read More..." class=read-more><i class="icon icon-ellipsis"></i></a></figcaption></figure><p>A simple feature that, by using the engine’s hot reloading functionality, <strong>reloads a previous version of the game <code class=highlighter-rouge>.dll/.so</code> when a crash occurs</strong>.</p><p>This is <strong>development only</strong> feature, that gives you a chance to quickly correct simple mistakes while debugging that would otherwise cause you to lose the state of the game.</p><p>I would strongly suggest against doing such shenanigans in shipping builds.</p><h2 id=implementing-crash-resurrection-in-your-engine>Implementing Crash Resurrection in Your Engine</h2><p>The process of gracefully recovering from most crashes is simple and can be broken up in the following steps:</p><ul><li>Step 0: Prerequisite: Hot reloading</li><li>Step 1: Backup the previous .dll</li><li>Step 2a: Add a crash handler on Linux/Mac</li><li>Step 2b: Add a crash handler on Windows</li><li>Step 3: Augment the Hot Reload functionality</li><li>Step 4: What about the debugger</li></ul><p>I’ll be referring to <code class=highlighter-rouge>dll</code> for simplicity when talking about shared libraries, but replace it with the extension used by your OS.</p><h3 id=step-0-prerequisite-hot-reloading><strong>Step 0</strong>: Prerequisite: Hot reloading</h3><p><em>Hot reloading</em> or <em>Live Code Editing</em> is the act of unloading and reloading a shared library without having to restart the main application. This is usually done whenever a newer version of the shared library is detected.</p><p>If you have used <a href=https://www.unrealengine.com>Unreal Engine</a> or watched <a href=https://twitter.com/cmuratori>Casey Muratori’s</a> excellent <a href="https://handmadehero.org/">Handmade Hero</a> series, you know how useful this feature can be, especially when rapidly iterating over code that needs to feel “just right”.</p><p>If your engine supports hot reloading read on, otherwise take a look at Handmade Hero’s <a href=https://hero.handmade.network/episode/win32-platform/day022>Day 22: Instantenous Live Code Editing</a> for a Windows implementation, and <a href="http://nullprogram.com/blog/2014/12/23/">Interactive Programming in C</a> by Chris Wellons, for Unix-like systems.</p><h3 id=step-1-backup-the-previous-dll><strong>Step 1</strong>: Backup the previous .dll</h3><p>In your build script, before your game library compilation step, make a backup of the previous version of the <code class=highlighter-rouge>.dll</code>, for example copy it to <code class=highlighter-rouge>game-backup.dll</code>.</p><p>You also have to check if the backup is being used by the game because of a recent crash. If this is the case you shouldn’t clobber it as the new code you are about to compile may crash too. You can do this check using the <a href=http://linux.die.net/man/8/lsof>lsof</a> command on Unix-like systems and <a href=https://technet.microsoft.com/en-us/sysinternals/bb896655.aspx>Handle</a> on Windows.</p><p>For example you could use the following bash script on Unix-like systems:</p><figure class=highlight><pre><code class=language-bash data-lang=bash><span class=c>#!/bin/bash</span>

<span class=nv>source_lib</span><span class=o>=</span>game.so
<span class=nv>backup_lib</span><span class=o>=</span>game-backup.so

<span class=c># Copy $source_lib to $backup_lib only if:</span>
<span class=c>#  - $source_lib exists and</span>
<span class=c>#  - $backup_lib is not open by a process</span>
<span class=k>if</span> <span class=o>[[</span> <span class=nt>-f</span> <span class=s2>"</span><span class=nv>$source_lib</span><span class=s2>"</span> <span class=o>&amp;&amp;</span> <span class=o>!</span> <span class=s2>"</span><span class=si>$(</span>lsof <span class=nv>$backup_lib</span> 2&gt; /dev/null<span class=si>)</span><span class=s2>"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then </span><span class=nb>cp</span> <span class=nv>$source_lib</span> <span class=nv>$backup_lib</span><span class=p>;</span> <span class=k>fi</span></code></pre></figure><p>I’m not really a Windows batch or PowerShell wizard, so I’ll leave the Windows implementation as an exercise for the reader.</p><h3 id=step-2a-add-a-crash-handler-on-linuxmac><strong>Step 2a</strong>: Add a crash handler on Linux/Mac</h3><p>On most Unix-like systems you can use POSIX <a href=http://man7.org/linux/man-pages/man7/signal.7.html>Signals</a> to recover from crashes. For example, the following code registers a signal handler for <code class=highlighter-rouge>SIGSEGV</code> and <code class=highlighter-rouge>SIGILL</code>, as I’ve found they are the most common and easily recoverable from, but you can register for any signal you are interested in handling.</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#include &lt;signal.h&gt;
#include &lt;setjmp.h&gt;
</span>
<span class=n>sigjmp_buf</span> <span class=n>RecoveryMarker</span><span class=p>;</span>
<span class=kt>int</span> <span class=n>GameRunning</span><span class=p>;</span>

<span class=kt>int</span> <span class=nf>ReloadGameCode</span><span class=p>(</span><span class=kt>int</span> <span class=n>UseBackup</span><span class=p>);</span>

<span class=kt>void</span> <span class=nf>SignalHandler</span><span class=p>(</span><span class=n>i32</span> <span class=n>Signal</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>siglongjmp</span><span class=p>(</span><span class=n>RecoveryMarker</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>struct</span> <span class=n>sigaction</span> <span class=n>SignalAction</span> <span class=o>=</span> <span class=p>{};</span>
  <span class=n>SignalAction</span><span class=p>.</span><span class=n>sa_handler</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>CrashHandler</span><span class=p>;</span>
  <span class=n>sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>SignalAction</span><span class=p>.</span><span class=n>sa_mask</span><span class=p>);</span>
  <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGSEGV</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>SignalAction</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGILL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>SignalAction</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>

  <span class=k>if</span><span class=p>(</span><span class=n>sigsetjmp</span><span class=p>(</span><span class=n>RecoveryMarker</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ReloadGameCode</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
    <span class=p>{</span>
      <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>while</span> <span class=p>(</span><span class=n>GameRunning</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=c1>// Game loop</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><h3 id=step-2b-add-a-crash-handler-on-windows><strong>Step 2b</strong>: Add a crash handler on Windows</h3><p>Windows provides the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680657(v=vs.85).aspx">Structured Exception Handling</a> (SEH) mechanisms that you can use to recover from a crash.</p><p>The following example is more or less equivalent to the Linux/Mac implementation presented above. I hope you don’t get heart palpitations at the sight of a <code class=highlighter-rouge>goto</code> statement ;-).</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=n>GameRunning</span><span class=p>;</span>

<span class=kt>int</span> <span class=nf>ReloadGameCode</span><span class=p>(</span><span class=kt>int</span> <span class=n>UseBackup</span><span class=p>)</span>

<span class=kt>int</span> <span class=n>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
<span class=nl>RecoveryMarker:</span>
  <span class=kr>__try</span>
  <span class=p>{</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>GameRunning</span><span class=p>)</span>
    <span class=p>{</span>
      <span class=c1>// Game loop</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=kr>__finally</span>
  <span class=p>{</span>
    <span class=c1>// Can use __except along with GetExceptionCode() and GetExceptionInformation() </span>
    <span class=c1>// to see if exception can be recovered from</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>ReloadGameCode</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
    <span class=p>{</span>
      <span class=k>goto</span> <span class=n>RecoveryMarker</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><h3 id=step-3-augment-the-hot-reload-functionality><strong>Step 3</strong>: Augment the Hot Reload functionality</h3><p>The <code class=highlighter-rouge>ReloadGameCode</code> function stubbed in the previous examples is in charge of <em>hot reloading</em> the game <code class=highlighter-rouge>.dll</code>. In its simplest form it can receive an argument receive an argument that tells it whether or not to reload the main <code class=highlighter-rouge>.dll</code> or a backup, like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=nf>ReloadGameCode</span><span class=p>(</span><span class=kt>int</span> <span class=n>UseBackup</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>int</span> <span class=n>Success</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>Filename</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>UseBackup</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>Filename</span> <span class=o>=</span> <span class=s>"game-backup.dll"</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=n>Filename</span> <span class=o>=</span> <span class=s>"game.dll"</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=c1>// Unload and reload shared library here. See references in</span>
  <span class=c1>// Step 0: Prerequisite: Hot reloading</span>
  <span class=c1>// for sample implementations</span>
  <span class=n>Success</span> <span class=o>=</span> <span class=p>...;</span>

  <span class=k>return</span> <span class=n>Success</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><h3 id=step-4-what-about-the-debugger><strong>Step 4</strong>: What about the debugger</h3><p>With <a href="https://www.gnu.org/software/gdb/">GDB</a> and GDB frontends, you can disable automatic breakpoints for specific signals using the <a href=https://sourceware.org/gdb/current/onlinedocs/gdb/Signals.html#Signals>handle</a> command (like I do in the demo video for <code class=highlighter-rouge>SIGSEGV</code>).</p><p>I’m not sure how to do the same in Visual Studio, as I don’t tend to use it much, but I guess there’s a similar feature… hopefully…maybe… I don’t know, sorry! :o(</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #36: Simple Crash Resurrection For C/C++ Game Engines&amp;url=https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-35-crash-resurrection-for-c-cpp-game-engines/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>
