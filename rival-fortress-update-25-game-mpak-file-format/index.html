<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Game MPAK file format | Metric Panda Games</title><meta name=description content="This week I updated the storage file format used in Rival Fortress. The previous file format was a quick implementation I came up with while still figuring out what was needed f..."><meta name=keywords><meta property=og:title content="Game MPAK file format | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/"><meta property=og:image content=https://metricpanda.commpak-file-format.png><meta name=twitter:title content="Game MPAK file format"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="This week I updated the storage file format used in Rival Fortress. The previous file format was a quick implementation I came up with while still figuring out what was needed f..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/"><meta name=twitter:image content=https://metricpanda.commpak-file-format.png><meta name=twitter:image:alt content="Game MPAK file format"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Game MPAK file format</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #25</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>This week I updated the storage file format used in <a href=/rival-fortress/index.html>Rival Fortress</a>. The <a href=/rival-fortress-update-2-preprocessing-and-bundling-game-assets/index.html>previous file format</a> was a quick implementation I came up with while still figuring out what was needed for the engine. Now that most of the engine functionality is fleshed out, I decided to revise the file format to better fit the engine’s needs.</p><h2 id=about-mpak>About MPAK</h2><p><strong>MPAK</strong> (Metric PAK) is a generalized binary file format optimized for disk streaming and network transmission. It is currently used to store:</p><ul><li>static game assets (e.g. meshes, textures, shaders)</li><li>runtime data (e.g. save games, profile data)</li><li>user generated content (e.g. <em>mod</em> logic and assets)</li></ul><p>The format also supports versioning and basic overwriting of previous assets: the engine at runtime loads all MPAKs and resolves any conflicting entries by keeping only the most recent one. This way mod authors can overwrite engine content by distributing custom MPAKs.</p><h2 id=file-structure>File structure</h2><p>MPAKs have a metadata preamble that contain:</p><ul><li>A header, with a file identifier, version flags and section count;</li><li>A list of sections, describing the categories, storage type and count of entries to expect in the file;</li><li>A list of entries, describing type, size, and offset of each entry.</li></ul><figure class=highlight><pre><code class=language-bash data-lang=bash>Byte[12] Identifier
UInt64 Timestamp
UInt32 Endianness
UInt32 Version
UInt32 Flags
UInt32 SectionCount

<span class=k>for </span>SectionIndex to SectionCount
  UInt64 SectionOffset
  UInt64 SectionSize
  UInt32 SectionType
  UInt32 SectionFlags
  UInt32 SectionEntryCount
  UInt32 SectionMetadataSize
end

<span class=k>for </span>EntryIndex to SectionEntryCount
  UInt64 EntryOffset
  UInt64 EntrySize
  UInt32 EntryType
  UInt32 EntryNameIndex
  UInt32 EntryID
end</code></pre></figure><p>All the metadata about the file is contained in the first bytes of the file, right after the header. This means that the engine can quickly parse the metadata to obtain the information needed in order to build the correct representation of the file entries, and resolve conflicts.</p><p>After the metadata has been parsed the engine can proceed to make the necessary allocations and load high priority data. Files containing entries that are not needed right away are memory-mapped in order to <em>lazy-load</em> large data blobs on demand.</p><p>Sections, that group entries together, are sort of like categories and represent an homogeneous list of items, like meshes, textures or sounds. This grouping by sections is a convenience feature to facilitate parsing of similar data, like shaders or LUA scripts, that can easily fit into memory without having to random access around the file. Data blobs for each section are stored sequentially and come after the last <code class=highlighter-rouge>Entry</code> in the metadata part of the file, at the 64 bit offsets specified by <code class=highlighter-rouge>EntryOffset</code>.</p><h2 id=nested-formats>Nested formats</h2><p>The MPAK file format specifies only the type, size and offset of each entry, not how it is stored. This allows the flexibility of treating different data types independently. For example: shaders are stored as <a href="https://cyan4973.github.io/lz4/">LZ4 compressed</a> text, while meshes are stored directly as vertex and index buffers. The code in charge of writing/reading each section decided how to store the data.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #25: Game MPAK file format&amp;url=https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-25-game-mpak-file-format/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>