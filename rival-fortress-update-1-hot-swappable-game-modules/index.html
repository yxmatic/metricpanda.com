<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hot Swappable Game Modules | Metric Panda Games</title><meta name=description content="Rival Fortress will use a custom 3D game engine that I’m building from scratch in C++ and a bit of Assembly.Currently the only dependencies for the game are SDL, and the truetyp..."><meta name=keywords><meta property=og:title content="Hot Swappable Game Modules | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Hot Swappable Game Modules"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Rival Fortress will use a custom 3D game engine that I’m building from scratch in C++ and a bit of Assembly.Currently the only dependencies for the game are SDL, and the truetyp..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Hot Swappable Game Modules"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Hot Swappable Game Modules</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #1</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p><a href=/rival-fortress/index.html>Rival Fortress</a> will use a custom 3D game engine that I’m building from scratch in C++ and a bit of Assembly. Currently the only dependencies for the game are <a href="https://www.libsdl.org/">SDL</a>, and the <a href=https://github.com/nothings/stb/blob/master/stb_truetype.h>truetype</a> library from <a href="http://nothings.org/">Sean Berret</a>.</p><p>The engine is still in active development, but so far the most fun and interesting feature has been the <em>Hot Swappable Game Modules</em>.</p><h3 id=fast-iteration>Fast iteration</h3><p>Zippy iteration times are very important to me. I hate having to wait around for compile times and having to close and re-open the game just to see some small changes in action, especially when I’m tweaking some game mechanic.</p><h3 id=data-orienteddriven>Data oriented/driven</h3><p>A commonly used approach is <a href=http://gamedevelopment.tutsplus.com/articles/what-is-data-oriented-game-engine-design--cms-21052>data-oriented game engine design</a>, or as Unreal Engine calls it <a href=https://docs.unrealengine.com/latest/INT/Gameplay/DataDriven/index.html>data driven gameplay</a>, where the engine supports loading <em>gameplay variables</em> from external files that are usually human editable, like CSV tables or Excel spreadsheets.</p><p>This works well for tweaking existing variables, but doesn’t allow you to add or remove variables, or even functions.</p><h3 id=scripting>Scripting</h3><p>Another approach often used is integrating a scripting using languages like <a href="http://www.lua.org/">Lua</a>, Python or JavaScript in the game engine. This is dobe by exposing bindings to the scripting language and a callable API that can be used to modify in real time game behavior.</p><p>This can be very useful, especially when thinking about game moddability, but the cost is in performance: A scripting language will never be as fast as native well optimized C/C++.</p><h2 id=modularity>Modularity</h2><p>The route I chose to take for Rival Fortress is to split the engine and game into shared libraries (DLLs for Windows, dylibs for OSX and libs on Linux). The game itself is launched through a thin shell executable that takes care of the initial bootstrapping and in turn loads all <em>compatible</em> libraries found in the game directory.</p><p>This is the stripped down part that makes it happen:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>for</span><span class=p>(</span><span class=n>u32</span> <span class=n>LibIdx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>LibIdx</span> <span class=o>&lt;</span> <span class=n>LibCount</span><span class=p>;</span> <span class=o>++</span><span class=n>LibIdx</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>MPEGameLib</span><span class=o>*</span> <span class=n>GameLib</span> <span class=o>=</span> <span class=n>MPE_LoadGameLib</span><span class=p>(</span><span class=n>Engine</span><span class=p>,</span> <span class=n>GameLibs</span><span class=p>[</span><span class=n>LibIdx</span><span class=p>]);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>GameLib</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=c1>// Lib initialization</span>
  <span class=p>}</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=n>MPE_LogWarn</span><span class=p>(</span><span class=s>"Couldn't load: %s"</span><span class=p>,</span> <span class=n>GameLibs</span><span class=p>[</span><span class=n>LibIdx</span><span class=p>]);</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></figure><p><code class=highlighter-rouge>GameLibs</code> is an array of <code class=highlighter-rouge>char*</code> (<code class=highlighter-rouge>wchar_t</code> on Windows) filenames populated by crawling the game directory and looking for libraries supported by the host operative system. <code class=highlighter-rouge>MPE_LoadGameLib</code> tries to load the shared library in memory and checks if it provides a valid entry point like so:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>Handle</span> <span class=o>=</span> <span class=n>dlopen</span><span class=p>(</span><span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>Path</span><span class=p>,</span> <span class=n>RTLD_LAZY</span> <span class=o>|</span> <span class=n>RTLD_GLOBAL</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>Handle</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>auto</span> <span class=n>EntryPoint</span> <span class=o>=</span> <span class=p>(</span><span class=n>MPEGameLibMetadata</span><span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=n>dlsym</span><span class=p>(</span><span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>Handle</span><span class=p>,</span> <span class=n>MPE_GAME_LIB_METADATA</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>EntryPoint</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=c1>// Populate GameLib metadata</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></figure><p><code class=highlighter-rouge>EntryPoint</code> is a function pointer that returns metadata information of the library, like version, dependencies, run priority, etc. It also contains the API with function pointers that will be called by the shell during execution, like so:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>struct</span> <span class=n>MPEGameLibAPI</span>
<span class=p>{</span>
  <span class=n>MPELibState</span><span class=o>*</span> <span class=p>(</span><span class=o>*</span><span class=n>Initialize</span><span class=p>)(</span><span class=n>MPEEngine</span><span class=o>*</span> <span class=n>Engine</span><span class=p>,</span> <span class=n>MPEGameState</span><span class=o>*</span> <span class=n>GameState</span><span class=p>);</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>Shutdown</span><span class=p>)(</span><span class=n>MPEEngine</span><span class=o>*</span> <span class=n>Engine</span><span class=p>,</span> <span class=n>MPEGameState</span><span class=o>*</span> <span class=n>GameState</span><span class=p>,</span> <span class=n>MPELibState</span><span class=o>*</span> <span class=n>State</span><span class=p>);</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>Reload</span><span class=p>)(</span><span class=n>MPEEngine</span><span class=o>*</span> <span class=n>Engine</span><span class=p>,</span> <span class=n>MPEGameState</span><span class=o>*</span> <span class=n>GameState</span><span class=p>,</span> <span class=n>MPELibState</span><span class=o>*</span> <span class=n>State</span><span class=p>);</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>Unload</span><span class=p>)(</span><span class=n>MPEEngine</span><span class=o>*</span> <span class=n>Engine</span><span class=p>,</span> <span class=n>MPEGameState</span><span class=o>*</span> <span class=n>GameState</span><span class=p>,</span> <span class=n>MPELibState</span><span class=o>*</span> <span class=n>State</span><span class=p>);</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>Step</span><span class=p>)(</span><span class=n>MPEEngine</span><span class=o>*</span> <span class=n>Engine</span><span class=p>,</span> <span class=n>MPEGameState</span><span class=o>*</span> <span class=n>GameState</span><span class=p>,</span> <span class=n>MPELibState</span><span class=o>*</span> <span class=n>State</span><span class=p>);</span>
<span class=p>};</span></code></pre></figure><p>As you can see, each library has its own state that is allocated from the main game allocator, as well as access to the engine and the global <code class=highlighter-rouge>GameState</code>.</p><h2 id=the-game-loop>The Game Loop</h2><p>Everything comes together in the main game loop as you can see in the following excerpt:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>while</span><span class=p>(</span><span class=n>Engine</span><span class=o>-&gt;</span><span class=n>GameRunning</span><span class=p>)</span>
<span class=p>{</span>
  <span class=c1>// Some stuff before</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>MPEGameLib</span><span class=o>*</span> <span class=n>GameLib</span> <span class=o>=</span> <span class=n>Engine</span><span class=o>-&gt;</span><span class=n>FirstGameLib</span><span class=p>;</span>
        <span class=n>GameLib</span><span class=p>;</span>
        <span class=n>GameLib</span> <span class=o>=</span> <span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>Next</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>IsStale</span><span class=p>)</span>
    <span class=p>{</span>
      <span class=n>MPE_Reload</span><span class=p>(</span><span class=n>GameLib</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>API</span><span class=p>.</span><span class=n>Step</span><span class=p>(</span><span class=n>Engine</span><span class=p>,</span> <span class=n>GameState</span><span class=p>,</span> <span class=n>GameLib</span><span class=o>-&gt;</span><span class=n>State</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// Some stuff after</span>
<span class=p>}</span></code></pre></figure><p>Each time through the main loop a link list sorted by priority is walked. Each module is reloaded if stale and the <code class=highlighter-rouge>Step</code> function pointer is called.</p><h2 id=the-janitor-does-all-the-work>The Janitor does all the work</h2><p>To ensure game modules are always up to date, the engine keeps a <em>Janitor</em> worker in a low priority thread that keeps checking the last write timestamp of the loaded modules, as well as looking for new modules in the game directory, and keeping the linked list sorted.</p><h2 id=hot-swappability>Hot swappability</h2><p>This allows the game to be edited and <em>tweaked in real-time, as each recompile is picked up immediately</em>.</p><p>The game state of each module is also preserved, since the main shell owns the memory from which it is allocated (I’ll talk more about the memory model used in Rival Fortress in a future update.)</p><p>All in all this has been a very fun feature to implement, and while is not really essential, it has been saving me a lot of “dead time” while rapidly iterating on ideas/implementations.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #1: Hot Swappable Game Modules&amp;url=https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-1-hot-swappable-game-modules/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>