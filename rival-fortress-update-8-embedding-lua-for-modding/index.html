<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Embedding Lua for Modding | Metric Panda Games</title><meta name=description content="The engine for Rival Fortress is coming along nicely, and in a few weeks I’ll probably start working on game code.This past week I integrated LuaJIT in the engine. LuaJIT is a j..."><meta name=keywords><meta property=og:title content="Embedding Lua for Modding | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Embedding Lua for Modding"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="The engine for Rival Fortress is coming along nicely, and in a few weeks I’ll probably start working on game code.This past week I integrated LuaJIT in the engine. LuaJIT is a j..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Embedding Lua for Modding"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Embedding Lua for Modding</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #8</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>The engine for <a href=/rival-fortress/index.html>Rival Fortress</a> is coming along nicely, and in a few weeks I’ll probably start working on game code.</p><p>This past week I integrated <a href="http://luajit.org/">LuaJIT</a> in the engine. LuaJIT is a <a href=https://en.wikipedia.org/wiki/Just-in-time_compilation>just in time</a> interpreter for the <a href="http://www.lua.org/">Lua</a> language that is lightweight and very fast.</p><h2 id=integrating-luajit>Integrating LuaJIT</h2><p>I’m statically linking the LuaJIT runtime as I intend to make some modifications to the implementation, especially to the memory allocation routines.</p><p>Other than that integration was quick an painless. The only tedious part was converting the <code class=highlighter-rouge>Makefile</code> based build system that LuaJIT uses into my <code class=highlighter-rouge>CMake</code> toolchain. If you are looking to do something similar I suggest starting from the <code class=highlighter-rouge>CMakeLists.txt</code> in the <a href=https://github.com/torch/luajit-rocks>luajit-rocks</a> repo.</p><h2 id=exposing-an-api-to-lua>Exposing an API to Lua</h2><p>In the engine I’m using Lua to expose an API that can be consumed by scripts and used in modding.</p><p>The API consists of a global <a>Lua table</a> that contains various functions that the modder can use to initialize the mod and register callbacks to specific events in the game lifetime. The API is still quite bare bones, as I intend to expose functionality as I need it while working on the actual game code. The idea is that most of the game specific logic will be implemented in Lua within the constraints of the engine.</p><h2 id=using-reflection-to-expose-functionality>Using reflection to expose functionality</h2><p>I’m using the <a>reflection system</a> I talked about the previous week to expose functionality to Lua. I do so by annotating <code class=highlighter-rouge>structs</code> and functions and the reflection system generates the boilerplate code needed to glue C and Lua together.</p><p>This is particularly useful for handling Lua-to-C type conversion and <a href=http://www.lua.org/pil/24.2.html>Lua Stack</a> management.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #8: Embedding Lua for Modding&amp;url=https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-8-embedding-lua-for-modding/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>