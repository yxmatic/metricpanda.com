<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Include Detective: Keep An Eye On Those Includes | Metric Panda Games</title><meta name=description content="Note: You can find the source code for Include Detective on Github.This weekend I wrote a little Bash script to investigate include chains of some system headers, and it turned ..."><meta name=keywords><meta property=og:title content="Include Detective: Keep An Eye On Those Includes | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/"><meta property=og:image content=https://metricpanda.cominclude-detective-windowsh-lean-and-mean.gif><meta name=twitter:title content="Include Detective: Keep An Eye On Those Includes"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Note: You can find the source code for Include Detective on Github.This weekend I wrote a little Bash script to investigate include chains of some system headers, and it turned ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/"><meta name=twitter:image content=https://metricpanda.cominclude-detective-windowsh-lean-and-mean.gif><meta name=twitter:image:alt content="Include Detective: Keep An Eye On Those Includes"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Include Detective: Keep An Eye On Those Includes</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #38</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p class=note><b>Note</b>: You can find the source code for <em>Include Detective</em> on <a href=https://github.com/MetricPanda/include-detective>Github</a>.</p><p>This weekend I wrote a little Bash script to investigate include chains of some system headers, and it turned out to be pretty useful, so that’s what I’ll talk about in this post.</p><p>This is what <strong>Include Detective</strong> looks like in action:</p><div class=post-media></div><h2 id=how-does-it-work>How does it work?</h2><p><em>Include Detective</em> is a bash script that runs the compiler on a dummy C or C++ file with just an <code class=highlighter-rouge>#include</code> directive. The <code class=highlighter-rouge>#include</code> points to the path or system header specified as argument to the script.</p><p>The compiler (GCC and Clang family of compilers) is invoked twice with flags <code class=highlighter-rouge>-E</code> and <code class=highlighter-rouge>-dM</code>.</p><p>The <code class=highlighter-rouge>-E</code> flag stops compilation after the preprocessing stage, resulting in an output where all headers have been inlined and preprocessor directives and macros expanded.</p><p>The <code class=highlighter-rouge>-dM</code> flag tells the compiler to dump all preprocessor defines (both builtin and the ones defined in the included files).</p><p>These outputs are then parsed and statistics printed as you can see above.</p><p>The source of the preprocessed file can be dumped by passing the <code class=highlighter-rouge>-p</code> (for print) before the filename. The following is the output from running <code class=highlighter-rouge>include-detective -p assert.h</code>:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=cp># 1 "&lt;stdin&gt;"
# 1 "&lt;built-in&gt;"
# 1 "&lt;command-line&gt;"
# 31 "&lt;command-line&gt;"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 32 "&lt;command-line&gt;" 2
# 1 "&lt;stdin&gt;"
# 1 "/usr/include/assert.h" 1 3 4
# 35 "/usr/include/assert.h" 3 4
# 1 "/usr/include/features.h" 1 3 4
# 368 "/usr/include/features.h" 3 4
# 1 "/usr/include/sys/cdefs.h" 1 3 4
# 415 "/usr/include/sys/cdefs.h" 3 4
# 1 "/usr/include/bits/wordsize.h" 1 3 4
# 416 "/usr/include/sys/cdefs.h" 2 3 4
# 369 "/usr/include/features.h" 2 3 4
# 392 "/usr/include/features.h" 3 4
# 1 "/usr/include/gnu/stubs.h" 1 3 4
# 10 "/usr/include/gnu/stubs.h" 3 4
# 1 "/usr/include/gnu/stubs-64.h" 1 3 4
# 11 "/usr/include/gnu/stubs.h" 2 3 4
# 393 "/usr/include/features.h" 2 3 4
# 36 "/usr/include/assert.h" 2 3 4
# 64 "/usr/include/assert.h" 3 4
# 67 "/usr/include/assert.h" 3 4
</span><span class=k>extern</span> <span class=kt>void</span> <span class=nf>__assert_fail</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__assertion</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__file</span><span class=p>,</span>
      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>__line</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__function</span><span class=p>)</span>
     <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__nothrow__</span> <span class=p>,</span> <span class=n>__leaf__</span><span class=p>))</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__noreturn__</span><span class=p>));</span>
<span class=k>extern</span> <span class=kt>void</span> <span class=nf>__assert_perror_fail</span> <span class=p>(</span><span class=kt>int</span> <span class=n>__errnum</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__file</span><span class=p>,</span>
      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>__line</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__function</span><span class=p>)</span>
     <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__nothrow__</span> <span class=p>,</span> <span class=n>__leaf__</span><span class=p>))</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__noreturn__</span><span class=p>));</span>
<span class=k>extern</span> <span class=kt>void</span> <span class=nf>__assert</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__assertion</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__file</span><span class=p>,</span> <span class=kt>int</span> <span class=n>__line</span><span class=p>)</span>
     <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__nothrow__</span> <span class=p>,</span> <span class=n>__leaf__</span><span class=p>))</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>__noreturn__</span><span class=p>));</span>
<span class=cp># 1 "&lt;stdin&gt;" 2</span></code></pre></figure><p>The lines beginning with <code class=highlighter-rouge>#</code> are special directives that the compiler inserts for debug purposes. You can read more about them on the <a href=https://gcc.gnu.org/onlinedocs/cpp/Preprocessor-Output.html>GCC man page</a>.</p><h2 id=why-is-it-useful>Why is it useful?</h2><p><em>Include Detective</em> can be useful when you are looking to eliminate headers in order to <strong>speed up compile times</strong> when using <a href=https://en.wikipedia.org/wiki/Single_Compilation_Unit>single translation unit builds</a>, in favor of <a href=https://en.wikipedia.org/wiki/Precompiled_header>precompiled headers</a>.</p><p>Some headers are fine, because you end up using most of the symbols they define.</p><p>Other headers not so much. Maybe they are huge and you only need the prototypes of a couple of functions; or maybe they recursively include many other headers, unnecessarily slowing down compile times.</p><p>In cases like this, it may be worth the effort to create your own <em>minimal header</em> that contains only the declarations you care about.</p><p><strong>A word of caution</strong>: removing a header and replacing it with your own slimmed-out version, requires you to make sure that the function prototypes or preprocessor defines are correct for all the architectures you are shipping to.</p><h2 id=a-simple-example-of-debloating>A simple example of “debloating”</h2><p>Here is a simple example of how you would go about eliminating a header dependency with your own slim version using the classic “Hello World, using both plain C and C++.</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=c1>// C++</span>
<span class=cp>#include &lt;iostream&gt;
</span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Hello World!"</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><div class=post-media></div><p>As you can see, the C++ program gets expanded into more than <strong>17000</strong> lines of code, included from <strong>134</strong> files. This process has to be done <em>every time you compile</em>. Quite crazy, if you only need a small subset of what’s declared in the header.</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=c1>// C</span>
<span class=cp>#include &lt;stdio.h&gt;
</span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>"Hello World!</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
<span class=p>}</span></code></pre></figure><div class=post-media></div><p>The C equivalent is much saner, with only <strong>295</strong> lines of code and <strong>16</strong> includes. Still, we are only calling a function, do we really need all that noise?</p><h2 id=removing-the-header-in-plain-c>Removing the header in plain C</h2><p>When coding in plain C the process is very easy, you just have to run <em>Include Detective</em> on the header you are interested in removing, and <code class=highlighter-rouge>grep</code> for the functions or <code class=highlighter-rouge>#defines</code> that you need:</p><p><code class=highlighter-rouge>include-detective -p stdio.h | grep printf -A 1</code></p><p>Notice that I used the <code class=highlighter-rouge>-p</code> flag, meaning the preprocessed header will be prited to <code class=highlighter-rouge>stdout</code>. Next I pipe the result to grep searching for <code class=highlighter-rouge>printf</code> and using the <code class=highlighter-rouge>-A 1</code> option, to tell grep that I want one line of context after each match, because I know that most function declarations in GCC’s headers span two or three lines.</p><p>This is the relevant output is:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>extern</span> <span class=kt>int</span> <span class=nf>printf</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=kr>__restrict</span> <span class=n>__format</span><span class=p>,</span> <span class=p>...);</span></code></pre></figure><p>Now all you have to do is copy and paste that line into the source file like so:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>extern</span> <span class=kt>int</span> <span class=nf>printf</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=kr>__restrict</span> <span class=n>__format</span><span class=p>,</span> <span class=p>...);</span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>"Hello World!</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
<span class=p>}</span></code></pre></figure><p>No more <code class=highlighter-rouge>#include &lt;stdio.h&gt;</code> and this will compile just fine.</p><p>Obviously you are not getting rid of the Standard Library, because the linker will still link to it, but the preprocessor stage of the compilation will be faster. In this simple case the speed increase is irrelevant, but as the number of includes grows, you will see a much larger benefit.</p><h2 id=removing-the-header-in-c>Removing the header in C++</h2><p>Well… Doing the same for the C++ example is quite a nightmare, as you can imagine from the fact that <code class=highlighter-rouge>#include &lt;iostream&gt;</code> brings in 17k lines of code.</p><p>I wouldn’t recommend doing it manually but if you figure out a smart way to automate it you can follow this process:</p><ol><li><p>output the preprocessed header with the <code class=highlighter-rouge>-p</code> option and using <code class=highlighter-rouge>MODE=cxx</code> to tell <em>Include Detective</em> that it’s working with C++ like so:</p><p><code class=highlighter-rouge>MODE=c++ include-detective -p iostream &gt; iostream-dump.cc</code></p></li><li><p>using <code class=highlighter-rouge>iostream-dump.cc</code> reconstruct the chain of <code class=highlighter-rouge>class</code>/<code class=highlighter-rouge>template</code>/<code class=highlighter-rouge>typedef</code> that make <code class=highlighter-rouge>cout</code> and <code class=highlighter-rouge>endl</code> possible, and copy them in your minimal include header</p></li></ol><p>The resulting header will not be a one-liner like in the C case, but it will certainly not be 17000 lines of code!</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #38: Include Detective: Keep An Eye On Those Includes&amp;url=https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>