<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time | Metric Panda Games</title><meta name=description content="__COUNTER__ is a preprocessor macro available in most compilers that expands to sequential integers starting from zero.It resets at the beginning of each new translation unit (i..."><meta name=keywords><meta property=og:title content="How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="__COUNTER__ is a preprocessor macro available in most compilers that expands to sequential integers starting from zero.It resets at the beginning of each new translation unit (i..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #39</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p><code class=highlighter-rouge>__COUNTER__</code> is a preprocessor macro available in most compilers that expands to sequential integers starting from zero.</p><p>It resets at the beginning of each new <a href=https://en.wikipedia.org/wiki/Translation_unit_(programming)>translation unit</a> (i.e. each object file), and is commonly used with the paste (<code class=highlighter-rouge>##</code>) operator to create unique identifiers within other macros.</p><p>While on working on the localization bits for <a href=/rival-fortress/index.html>Rival Fortress</a>, I stumbled upon an interesting usage for <code class=highlighter-rouge>__COUNTER__</code> that has allowed me to generate fast localization lookups and string hashing that are resolved at compile time and have an API that looks like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define T(X) Translate(__COUNTER__)
#define H(X) HashString(__COUNTER__)
</span>
<span class=kt>void</span> <span class=nf>SomeFunction</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>"%s %u</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span> <span class=n>T</span><span class=p>(</span><span class=s>"Hello"</span><span class=p>),</span> <span class=n>H</span><span class=p>(</span><span class=s>"asset.png"</span><span class=p>));</span> <span class=c1>// Prints "Hola 1927298820"</span>
<span class=p>}</span></code></pre></figure><p>In this post I’ll talk about what goes on behind the scenes of the previous snippet of code.</p><h2 id=guaranteed-monotonic>Guaranteed monotonic</h2><p>I’m compiling the project as a <a href=https://en.wikipedia.org/wiki/Single_Compilation_Unit>single compilation unit</a> (a.k.a. unity build), meaning all source files are included from one master source. The main advantage of this approach is fast compilation times: the codebase currently clocks in at about 95k LOC and compiles in less than a second in debug mode.</p><p>The other advantage of using a unity build is that <code class=highlighter-rouge>__COUNTER__</code> is guaranteed to be strictly monotonic, meaning no two values it produces are equal.</p><p>Having a unique counter means that lookup tables can become a thing.</p><p>Lookup tables indexed on compile time constants are trivial to inline by any compiler worth its salt, so that’s exactly what I did.</p><h2 id=metareflect-refresher>Metareflect refresher</h2><p>I previously talked about the custom <a href=/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html>reflection preprocessor</a> that I implemented in order to automate generation of config files from <code class=highlighter-rouge>structs</code>.</p><p>As a refresher, <strong>Metareflect</strong>, as I’ve called it, is a standalone executable that runs before the compiler, as part of the build process.</p><p>It lexes and parses C code in the same manner as a compiler front end does in the preprocessing phase, and looks for special annotation tokens that look like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define MREFLECT(...)
</span>
<span class=n>MREFLECT</span><span class=p>(</span><span class=n>Struct</span><span class=p>)</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=n>MPEConfig</span>
<span class=p>{</span>
  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>Config</span> <span class=o>=</span> <span class=s>"Engine"</span><span class=p>,</span> <span class=n>Default</span> <span class=o>=</span> <span class=n>DEFAULT_FULLSCREEN_MODE</span><span class=p>)</span>
  <span class=n>MPEFullscreenMode</span> <span class=n>FullscreenMode</span><span class=p>;</span>
<span class=p>}</span> <span class=n>MPEConfig</span><span class=p>;</span></code></pre></figure><p>As you can see, the <code class=highlighter-rouge>MREFLECT()</code> macro expands to nothing at compile time, but is used as an annotation that Metareflect understands and uses as a directive to generate code.</p><p>The previous snippet, for example, would cause Metareflect to generate the code needed for reading and writing the <code class=highlighter-rouge>struct</code> to and from an <code class=highlighter-rouge>INI</code>. <code class=highlighter-rouge>Config</code> and <code class=highlighter-rouge>Default</code> are options that, in this case, tell Metareflect that the configuration setting should be placed in the <code class=highlighter-rouge>[Engine]</code> section with a default value of <code class=highlighter-rouge>DEFAULT_FULLSCREEN_MODE</code>.</p><p>The generated code is saved in the <code class=highlighter-rouge>src/generated/</code> folder and included by the rest of the codebase. If you are familiar with Unreal Engine, I’ve based Metareflect on their “<em>UPROPERTY</em>” reflection system.</p><h2 id=generating-translation-lookup-tables>Generating translation lookup tables</h2><p>I expanded Metareflect making it generate the code for a lookup table for translation entries using <code class=highlighter-rouge>__COUNTER__</code>, and this is what it looks like:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define T(X) Translate(__COUNTER__)
</span>
<span class=k>static</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>GlobalTranslationTable</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>

<span class=kr>inline</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=nf>Translate</span><span class=p>(</span><span class=kt>int</span> <span class=n>Counter</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>Counter</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
    <span class=k>case</span> <span class=mi>5</span><span class=p>:</span>
    <span class=k>case</span> <span class=mi>7</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>GlobalTranslationTable</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
    <span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
    <span class=k>case</span> <span class=mi>6</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>GlobalTranslationTable</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
    <span class=k>case</span> <span class=mi>4</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>GlobalTranslationTable</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
  <span class=p>}</span>
  <span class=c1>// This is never executed</span>
  <span class=k>return</span> <span class=s>""</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>The <code class=highlighter-rouge>switch</code> statement maps each <code class=highlighter-rouge>__COUNTER__</code> value to a string. As you can see, it handles duplicate strings by collapsing <code class=highlighter-rouge>case</code> statements.</p><p>The number of entries in the <code class=highlighter-rouge>GlobalTranslationTable</code> is calculated by Metareflect by counting unique entries passed to the <code class=highlighter-rouge>T(X)</code> macro. These entries are stored in a simple hashtable-like data structure that uses the argument of the <code class=highlighter-rouge>T(X)</code> macro hashed as a 32 bit unsigned integer as key. Eventual key collision can easily resolved by adding a second parameter to the macro and using it as seed for the hash function.</p><p><code class=highlighter-rouge>GlobalTranslationTable</code> is populated at runtime from either from the default <code class=highlighter-rouge>char*</code> array, that contains the entries found in the source code or from a binary localization file, also generated by Metareflect. Changing language is simply a matter of <code class=highlighter-rouge>memcpy</code>-ing the correct translation table over the global.</p><p>This approach is very fast, as the <code class=highlighter-rouge>Translate</code> function is guaranteed to be inlined because <code class=highlighter-rouge>Counter</code> is known at compile time. The compiler will replace each call to <code class=highlighter-rouge>Translate</code> with a <code class=highlighter-rouge>mov</code> instruction pointing to the offset in the <code class=highlighter-rouge>GlobalTranslationTable</code> that in turn contains a pointer to the localized string.</p><h2 id=outputting-translator-friendly-csv-files>Outputting Translator friendly CSV files</h2><p>Using Metareflect I’m also generating CSV files for translators. The CSVs use the argument of the <code class=highlighter-rouge>T(X)</code> macro as key, so the binary translation file can be remapped to the correct <code class=highlighter-rouge>__COUNTER__</code> even if the lines of code are swapped. This is a one time operation that happens on startup.</p><h2 id=hashing-strings-at-compile-time>Hashing strings at compile time</h2><p>Leveraging the same code that generates translation lookup tables, I was also able to make lookup tables for string hashes that look like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define H(X) HashString(__COUNTER__)
</span>
<span class=k>static</span> <span class=kt>uint32_t</span> <span class=n>GlobalStringHashTable</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>

<span class=kr>inline</span> <span class=kt>uint32_t</span> <span class=nf>HashString</span><span class=p>(</span><span class=kt>int</span> <span class=n>Counter</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>Counter</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
    <span class=k>case</span> <span class=mi>3</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>GlobalStringHashTable</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
    <span class=k>case</span> <span class=mi>8</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>GlobalStringHashTable</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
  <span class=p>}</span>
  <span class=c1>// This is never executed</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>This function is also easily inlined by the compiler so it collapses down to just numbers that replace the macro invocations.</p><h2 id=does-it-slow-down-compilation-time>Does it slow down compilation time</h2><p>No. Currently Metareflect is able to do its thing in less than 40ms, spitting out about 15k LOC that include code generated for custom data structures, allocators, INI/JSON reader/writers, networking and more.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #39: How I Use __COUNTER__ To Localize Text And Hash Strings At Compile Time&amp;url=https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>