<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows | Metric Panda Games</title><meta name=description content="If you have a cross-compiling toolchain for building Windows executables read on.I use both Clang and Mingw-w64, and I’ve recently discovered a “fun” little gotcha that has to d..."><meta name=keywords><meta property=og:title content="Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="If you have a cross-compiling toolchain for building Windows executables read on.I use both Clang and Mingw-w64, and I’ve recently discovered a “fun” little gotcha that has to d..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #45</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>If you have a cross-compiling toolchain for building Windows executables read on.</p><p>I use both <a href="https://clang.llvm.org/">Clang</a> and <a href=https://mingw-w64.org/doku.php>Mingw-w64</a>, and I’ve recently discovered a “fun” little gotcha that has to do with the <code class=highlighter-rouge>__chkstk</code> routine that is output automatically by the code generator of both compilers.</p><h2 id=what-is-__chkstk>What is __chkstk</h2><p>The <a href="https://msdn.microsoft.com/en-us/library/ms648426(v=vs.85).aspx"><code class=highlighter-rouge>__chkstk</code> routine</a> (also known as <code class=highlighter-rouge>__alloc_probe</code>) is a little procedure that is inserted by compilers targeting Windows executables in the prologue code for each function that uses more that 4K bytes (8K in 64bit).</p><p>By default Windows allocates stack space in 4K pages with a <em>guard page</em> at the end that triggers an access violation when the program tries to access it, causing the operating system to allocate more stack space.</p><p>A problem arises when a function uses more than 2 pages for its stack variables. This means that it could possibly access memory <strong>past</strong> the guard page, thus triggering an access violation that won’t be handled by the OS as a simple request for more stack space, but as a generic exception that would terminate the application.</p><p><code class=highlighter-rouge>__chkstk</code> is the solution to this problem. Upon function entry, it touches memory addresses every 4K from the current stack pointer location up to the size needed by the function. This triggers the guard pages in the proper sequence and commits additional memory to the stack as required.</p><p><code class=highlighter-rouge>__chkstk</code> can also speed up your application’s start up time, even though, for most indie games and even some triple A game, the speed up will be negligible.</p><p>Read <a href=https://msdn.microsoft.com/library/aa290051.aspx>Compiler Security Checks In Depth</a> for more details.</p><h2 id=why-you-may-not-want-__chkstk>Why you may not want __chkstk</h2><p>As you may imagine, having this little routine run on <strong>every function call</strong> is wasteful. The cost of each page fault is paid only once, but <code class=highlighter-rouge>__chkstk</code> has to do its little dance and burn cycles on instructions that do nothing every time a function is called.</p><p>Fortunately it can be disabled on MSVC with the following <code class=highlighter-rouge>cl.exe</code> flags:</p><ul><li><a href="https://msdn.microsoft.com/en-us/library/9598wk25.aspx?f=255&amp;MSPPError=-2147217396">/GsXXX</a> where <code class=highlighter-rouge>XXX</code> is the threshold in bytes that prompts the insertion of the <code class=highlighter-rouge>__chkstk</code> probe. If you set this to a high number, like 10000000, no stack probes will be inserted.</li><li><a href=https://msdn.microsoft.com/en-us/library/8cxs58a6.aspx>/STACK:reserve[,commit]</a> reserves and, more importantly, <strong>commits</strong> the specified bytes for stack space used by the application. By default <code class=highlighter-rouge>reserve</code> is 1 MB and <code class=highlighter-rouge>commit</code> is 4 KB, so if you set both reserve and commit to the same number you won’t have to manually trigger faults to expand stack space.</li></ul><h2 id=llvm-and-mingw-dont-support-__chkstk-disabling>LLVM and mingw don’t support __chkstk disabling</h2><p>Unfortunately LLVM’s code generator for Windows targets use an <a href=https://github.com/llvm-mirror/llvm/blob/cd5b3fa3e75b54b04a3ef6ce5229f1c6b0d6b2b8/lib/Target/X86/X86FrameLowering.cpp#L950-L958>hard-coded probe size of 4K</a> as of LLVM 5.0, and this size can only be changed on a per-function basis with the <code class=highlighter-rouge>stack-probe-size</code> function attribute.</p><p>The same goes for mingw-w64, as it automatically outputs the <code class=highlighter-rouge>__chkstk_ms</code> probe for functions that use more than 4 KB, and to my knowledge there is no way to change this, but I didn’t dig deep in the source, as I use mingw only for continuous integration, and not for my main builds.</p><p>The solution I went with is to just redefine the function <code class=highlighter-rouge>__chkstk</code> as a <strong>no-op</strong> in assembly like so:</p><figure class=highlight><pre><code class=language-asm data-lang=asm>.text
.global __chkstk
__chkstk:
  ret</code></pre></figure><p>When I’ll get further along and lock all toolchain versions, I’ll modify the source to the Windows LLVM code generator to remove the call to <code class=highlighter-rouge>__chkstk</code>, but for now this is a quick and painless solution.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #45: Dealing with __chkstk/__chkstk_ms when Cross-Compiling For Windows&amp;url=https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-45-dealing-with-__chkstk-__chkstk_ms-when-cross-compiling-for-windows/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>