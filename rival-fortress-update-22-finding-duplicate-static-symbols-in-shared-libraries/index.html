<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Finding Duplicate Static Symbols in Shared Libraries | Metric Panda Games</title><meta name=description content="Sometimes it is useful to split code into shared libraries that get loaded by the main executable depending on runtime requirements.For example, the current development version ..."><meta name=keywords><meta property=og:title content="Finding Duplicate Static Symbols in Shared Libraries | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/"><meta property=og:image content=https://metricpanda.comrival-fortress-shared-libraries.png><meta name=twitter:title content="Finding Duplicate Static Symbols in Shared Libraries"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Sometimes it is useful to split code into shared libraries that get loaded by the main executable depending on runtime requirements.For example, the current development version ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/"><meta name=twitter:image content=https://metricpanda.comrival-fortress-shared-libraries.png><meta name=twitter:image:alt content="Finding Duplicate Static Symbols in Shared Libraries"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Finding Duplicate Static Symbols in Shared Libraries</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #22</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>Sometimes it is useful to split code into shared libraries that get loaded by the main executable depending on runtime requirements.</p><p>For example, the current development version of <a href=/rival-fortress/index.html>Rival Fortress</a> is structured like so:</p><div class=post-media></div><ul><li>The <strong>Launcher</strong> is the main executable that contains shared data types, interacts with the OS and abstracts away any platform related functionality needed by the shared libraries.</li><li>The <strong>Game</strong> is a shared library that contains all engine and game code. Keeping it in a library makes it easy to <a href=/rival-fortress-update-1-hot-swappable-game-modules/index.html>hot reload</a> it without having to restart the game.</li><li>The <strong>Networking</strong> library is loaded when the player initiates a multiplayer game or when the game is started as a headless dedicated server.</li><li>The <strong>Editor</strong> is also a shared library with the code for the gameplay editor. It can be loaded and unloaded by pressing <code class=highlighter-rouge>F11</code> while the game is running.</li></ul><h2 id=duplicate-static-functions>Duplicate static functions</h2><p>Partitioning code across multiple modules can cause logic defined in <code class=highlighter-rouge>static</code> functions to be duplicated silently and, while it will compile just fine and won’t cause any problems at runtime, it will unnecessarily bloat the size of the <code class=highlighter-rouge>.dll</code>/<code class=highlighter-rouge>.dynlib</code>/<code class=highlighter-rouge>.so</code>. Duplicate functions can also cause subtle bugs when shared libraries are built with different versions of the code, but this won’t happen if you build all your modules when common code changes.</p><p>For example, imagine you have the following function defined in <code class=highlighter-rouge>utility.c</code> that gets included in both the <em>Game</em> and <em>Editor</em> shared libraries.</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>static</span> <span class=kt>int</span> <span class=nf>ComplexOperation</span><span class=p>(</span><span class=kt>int</span> <span class=n>Value</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>return</span> <span class=n>Value</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>Each library will get a copy of the function and because it’s defined as <code class=highlighter-rouge>static</code> you will not get any compiler warning about the duplication.</p><p>To see for yourself you can the <a href=http://linux.die.net/man/1/nm>nm</a> tool on Linux and OSX or <a href=https://msdn.microsoft.com/en-us/library/20y05bd5.aspx>dumpbin</a> on Windows with the <code class=highlighter-rouge>/SYMBOLS</code> flag. Both tools will show you the symbols table exported by the library or executable. This is what <code class=highlighter-rouge>nm</code> outputs when run on OSX:</p><figure class=highlight><pre><code class=language-asm data-lang=asm>0000000000000fa0 t _ComplexOperation</code></pre></figure><h2 id=finding-duplicate-symbols>Finding duplicate symbols</h2><p>If you <em>reverse diff</em> the output of <code class=highlighter-rouge>nm</code> or <code class=highlighter-rouge>dumpbin</code> of two libraries you will find duplicate symbols.</p><p>Before you do that, though, you need to massage the output a bit. On *nix based systems, or by using <a href="https://blogs.windows.com/buildingapps/2016/03/30/run-bash-on-ubuntu-on-windows/">bash.exe</a>, you can use the following command:</p><figure class=highlight><pre><code class=language-bash data-lang=bash><span class=nv>$ </span>nm sharedlib.so | c++filt | <span class=nb>cut</span> <span class=nt>-d</span> <span class=s1>' '</span> <span class=nt>-f</span> 3-99 | <span class=nb>sort</span> | <span class=nb>uniq</span></code></pre></figure><ul><li><code class=highlighter-rouge>nm</code> returns the list of symbols in the library<ul><li>Omit this if you are using <code class=highlighter-rouge>bash.exe</code> on Windows 10, and <code class=highlighter-rouge>cat</code> the output of <code class=highlighter-rouge>dumpbin</code></li></ul></li><li><code class=highlighter-rouge>c++filt</code> <a href=https://en.wikipedia.org/wiki/Name_mangling>demangles</a> any C++ symbols. You can read more about it on the <a href=http://linux.die.net/man/1/c++filt>man page</a>,</li><li><code class=highlighter-rouge>cut</code> trims the first two tokens of each line that contain the memory location of the symbol, as it will more than likely differ for each library,</li><li><code class=highlighter-rouge>sort</code> sorts the symbols in alphabetical order (instead of being sorted in ascending memory location order)</li><li><code class=highlighter-rouge>uniq</code> removes any duplicate symbols (this is useful when deadling with C++ code)</li></ul><p>You can optionally filter the results using <code class=highlighter-rouge>grep</code> if you use common prefixes for all your functions, as this will remove all the noise generated by compiler defined symbols.</p><p>Use the <a href=http://linux.die.net/man/1/comm>comm</a> command to <em>reverse diff</em> the outputs like so:</p><figure class=highlight><pre><code class=language-asm data-lang=asm>$ comm -12 output1.txt output2.txt</code></pre></figure><p>Now that you know what symbols are duplicated it’s up to you decide how to best clean things up.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #22: Finding Duplicate Static Symbols in Shared Libraries&amp;url=https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-22-finding-duplicate-static-symbols-in-shared-libraries/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>