<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bye Bye CMake | Metric Panda Games</title><meta name=description content="In the past months working on Rival Fortress I found myself having to spend an unreasonable amount of time fussing with CMake build scripts.Don’t get me wrong, I like CMake.I th..."><meta name=keywords><meta property=og:title content="Bye Bye CMake | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/"><meta property=og:image content=https://metricpanda.comspring-cleaning.png><meta name=twitter:title content="Bye Bye CMake"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="In the past months working on Rival Fortress I found myself having to spend an unreasonable amount of time fussing with CMake build scripts.Don’t get me wrong, I like CMake.I th..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/"><meta name=twitter:image content=https://metricpanda.comspring-cleaning.png><meta name=twitter:image:alt content="Bye Bye CMake"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Bye Bye CMake</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #30</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>In the past months working on <a href=/rival-fortress/index.html>Rival Fortress</a> I found myself having to spend an unreasonable amount of time fussing with CMake build scripts.</p><p>Don’t get me wrong, I like <a href="https://cmake.org/">CMake</a>.</p><p>I think it’s an excellent tool if you have to manage complex build systems that have to work on multiple platforms and multiple toolchains. It abstracts away details of the build tool with a nice <a href=https://en.wikipedia.org/wiki/Domain-specific_language>DSL</a> that truly makes builds easier.</p><p>Unfortunately it can also make you waste a lot of time, especially if you are trying to do something that’s outside the standard usage pattern.</p><h2 id=my-bad-experiences-with-cmake>My bad experiences with CMake</h2><h3 id=nasm>NASM</h3><p>Back in December I wrote about <a href=/using-nasm-with-cmake-and-clang/index.html>how to make CMake behave nicely with NASM</a>. I remember wasting quite some time digging through CMake’s source trying to figure out a solution on how to have CMake detect NASM correctly. This has since been fixed in recent versions of CMake.</p><h3 id=custom-preprocessor>Custom preprocessor</h3><p>When I implemented the engine’s <a href=/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html>Meta reflection system</a> I had to hack together a reasonably complicated solution in order to have my custom preprocessor run before the normal build, while also tracking generated files. Something that really should be trivial to implement.</p><h3 id=clang-cl>Clang-cl</h3><p>Recently I had to dig into CMake’s source once again, trying to figure out how to make it recognize <a href="https://blogs.msdn.microsoft.com/vcblog/2015/05/01/bringing-clang-to-windows/">Clang/C2 with Microsoft Codegen</a>. I wasted a couple of days trying to get it pass the correct build flags, and stop it from detecting MSVC instead of Clang. In the end I ended up with forking the CMake repo and change the hard-coded scripts to make it do what I needed.</p><h3 id=cmakeliststxt-spam>CMakeLists.txt spam</h3><p>This is more of a pet peeve of mine, but I really hate the proliferation <code class=highlighter-rouge>CMakeLists.txt</code> files. I know that I can easily stuff all my build directives into one “master” <code class=highlighter-rouge>CMakeLists.txt</code>, but CMake best practices dictate that each logical build unit should be governed by its own <code class=highlighter-rouge>CMakeLists.txt</code>. I find this makes builds hard to modify as you have to jump back and forth between multiple files just to figure out what’s going on.</p><h2 id=back-to-the-basics>Back to the basics</h2><p>Yesterday I nuked CMake and rewrote the build system in good ol’ <a href="https://www.gnu.org/software/make/">GNU Make</a>.</p><p>I’m now down to one <code class=highlighter-rouge>Makefile</code> of a couple hundred lines of code, instead of seven <code class=highlighter-rouge>CMakeLists.txt</code>.</p><p>The build system is able to:</p><ul><li>output five build targets:<ul><li>Meta reflection preprocessor</li><li>Asset packer</li><li>Game server</li><li>Game client</li><li>Game DLL for hot reloading</li></ul></li><li>native compile on Linux and Mac using Clang and on Windows using Clang-cl</li><li>cross compile to Windows and Mac (from Linux) for 64 and 32 bits</li><li>generate <code class=highlighter-rouge>HTML</code> game documentation from <strong>Markdown</strong> files in the <code class=highlighter-rouge>/docs</code> folders</li><li>pack assets when out of date or modified</li><li>build and runs the preprocessor, correctly tracking generated files</li><li>assemble <code class=highlighter-rouge>.asm</code> files using NASM</li></ul><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #30: Bye Bye CMake&amp;url=https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-30-bye-bye-cmake/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>