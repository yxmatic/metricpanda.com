<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Deferred Shading and packed Uniform Buffer Objects | Metric Panda Games</title><meta name=description content="This past week I did some more work on the rendering engine for Rival Fortress by adding a deferred shading path.Deferred rendering is particularly useful when working with many..."><meta name=keywords><meta property=og:title content="Deferred Shading and packed Uniform Buffer Objects | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Deferred Shading and packed Uniform Buffer Objects"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="This past week I did some more work on the rendering engine for Rival Fortress by adding a deferred shading path.Deferred rendering is particularly useful when working with many..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Deferred Shading and packed Uniform Buffer Objects"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Deferred Shading and packed Uniform Buffer Objects</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #17</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>This past week I did some more work on the rendering engine for <a href=/rival-fortress/index.html>Rival Fortress</a> by adding a <a href=https://en.wikipedia.org/wiki/Deferred_shading>deferred shading</a> path.</p><p>Deferred rendering is particularly useful when working with many dynamic lights, and since I really want to have light/dark mechanics in the game, a combination of forward and deferred shading is the right fit for the engine.</p><p>I also started laying the groundwork for the post process chain as well as conditional shader compilation based on user settings and hardware capabilities.</p><h2 id=automatic-opengl-packed-uniform-layouts>Automatic OpenGL packed uniform layouts</h2><p>While working on the renderer I also extended the <a href=/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html>reflection preprocessor</a> by adding the ability to generate OpenGL <a href=https://www.opengl.org/wiki/Uniform_Buffer_Object>uniform buffer object</a> metadata for both <a href=https://www.opengl.org/wiki/Interface_Block_(GLSL)#Memory_layout>shared and packed</a> memory layouts.</p><p>The advantage of using <code class=highlighter-rouge>shared</code> or <code class=highlighter-rouge>packed</code> comes in the form of better memory utilization, and potentially better performance (due to better memory alignment) compared to the <code class=highlighter-rouge>std140</code> memory layout.</p><p>The downside is that you have to query uniform memory locations and strides manually for each uniform block as there are no constraints on how the driver will rearrange or pad your uniforms. This means you can’t simply <code class=highlighter-rouge>memcpy</code> your struct into the uniform buffer when you want to update it.</p><h2 id=preprocessing-struct-metadata>Preprocessing struct metadata</h2><p>To avoid the error prone process of manually having to fuss with the alignment code whenever I add or modify a uniform, I extended the engine preprocessor to look for structs annotated like the following:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=n>MREFLECT</span><span class=p>(</span><span class=n>UniformBlock</span><span class=p>,</span> <span class=n>Name</span><span class=o>:</span><span class=s>"MPECamera"</span><span class=p>)</span>
<span class=k>struct</span> <span class=n>MPECameraUniformBlock</span>
<span class=p>{</span>
  <span class=n>MPEMatrix4</span> <span class=n>ViewProjectionMatrix</span><span class=p>;</span>
  <span class=n>MPEMatrix4</span> <span class=n>InverseProjectionMatrix</span><span class=p>;</span>
  <span class=n>MPEVec4</span> <span class=n>CameraPosition</span><span class=p>;</span>
  <span class=n>MPEVec4</span> <span class=n>CameraDirection</span><span class=p>;</span>
  <span class=kt>void</span><span class=o>*</span> <span class=n>PackingInfo</span><span class=p>;</span>
  <span class=n>u32</span> <span class=n>Offset</span><span class=p>;</span>
  <span class=n>u32</span> <span class=n>Size</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure><p>The <code class=highlighter-rouge>MREFLECT</code> annotation is a no-op macro that tells the preprocessor that it should generate code for a uniform block named <code class=highlighter-rouge>MPECamera</code>.</p><p>The preprocessor then goes ahead and generates all the boilerplate code required to query the graphics card for uniform alignment, padding, and stride of each of the members of the struct, as well as the code needed to update the uniform.</p><p>The <code class=highlighter-rouge>void*</code> points to one of many types of packing information that is determined at runtime based on how the driver decides to layout the data and is used whenever the uniform needs to be updated.</p><p>Since all the code that does the <em>dirty work</em> is automatically generated by the preprocessor using a <code class=highlighter-rouge>void*</code> has more flexibility and less baggage than using templates or inheritance as type safety is enforced at compile time.</p><h2 id=aligning-for-better-packing>Aligning for better packing</h2><p>Most modern cards will pad uniform entries so that they are aligned to 16 byte boundaries when using the <code class=highlighter-rouge>shared</code> or <code class=highlighter-rouge>packed</code> memory layout.</p><p>For this reason it is often better to aggregate variables in four component vectors like <code class=highlighter-rouge>vec4</code> or <code class=highlighter-rouge>ivec4</code> and use <a href=https://www.opengl.org/wiki/Data_Type_(GLSL)#Swizzling>swizzling</a> to access the individual variables in the shaders. That is also the reason why I chose a <code class=highlighter-rouge>MPEVec4</code> (a four component vector) to represent camera position and direction in the previous code snippet.</p><h2 id=pooling-uniform-blocks-in-large-buffers>Pooling uniform blocks in large buffers</h2><p>Another useful optimization when dealing with uniform buffer objects is pooling multiple blocks into large buffer objects, similarly to how you would pool multiple meshes in VBO.</p><p>For example, in Rival Fortress the lighting, camera, and world data uniform blocks are all stored in a single buffer object, thus reducing buffer switches.</p><p>Adding a path for when the <a href=https://www.opengl.org/registry/specs/ARB/buffer_storage.txt>ARB_buffer_storage</a> extension is supported allows you to get a pointer that you can write into whenever you need to update your uniforms without having to do any <code class=highlighter-rouge>gl</code> calls. For more information on this and other low overhead OpenGL techniques I suggest you take a look at the Steam Dev Days talk <a href="https://www.youtube.com/watch?v=-bCeNzgiJ8I">Beyond Porting: How Modern OpenGL Can Radically Reduce Driver Overhead</a> (<a href=http://media.steampowered.com/apps/steamdevdays/slides/beyondporting.pdf>The slides are here</a>).</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #17: Deferred Shading and packed Uniform Buffer Objects&amp;url=https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-17-deferred-shading-and-packed-uniform-buffer-objects/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>