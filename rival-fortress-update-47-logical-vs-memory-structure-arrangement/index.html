<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Logical vs Memory Structure Arrangement | Metric Panda Games</title><meta name=description content="In a previous post I talked about how avoiding automatic structure padding can be beneficial for performance, because of the importance of cache locality in modern CPU architect..."><meta name=keywords><meta property=og:title content="Logical vs Memory Structure Arrangement | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Logical vs Memory Structure Arrangement"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="In a previous post I talked about how avoiding automatic structure padding can be beneficial for performance, because of the importance of cache locality in modern CPU architect..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Logical vs Memory Structure Arrangement"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Logical vs Memory Structure Arrangement</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #47</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>In a previous post I talked about how <a href=/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/index.html>avoiding automatic structure padding</a> can be beneficial for performance, because of the importance of <a href=https://en.wikipedia.org/wiki/CPU_cache#Cache_miss>cache locality</a> in modern CPU architectures.</p><p>Today I’ll talk about why I wish C or C++ would allow us to specify a <strong>logical arrangement</strong> for <code class=highlighter-rouge>struct</code> members in order to increase code readability.</p><h2 id=data-structure-alignment>Data structure alignment</h2><p>If you specify a structure or class in C/C++, the compiler will arrange its members in memory in the same order as you specified them in the <code class=highlighter-rouge>struct</code>/<code class=highlighter-rouge>class</code> definition (ignoring for the sake of simplicity virtual table pointers added in C++).</p><p>So, for example, the following <code class=highlighter-rouge>struct</code> will have the member <code class=highlighter-rouge>X</code> come before <code class=highlighter-rouge>Y</code> in memory.</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=n>MyData</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=n>X</span><span class=p>;</span> <span class=c1>// 1 byte</span>
  <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>  <span class=c1>// 4 bytes</span>
<span class=p>};</span></code></pre></figure><p>In this case, the compiler will also insert 3 bytes of padding after <code class=highlighter-rouge>X</code> in order to keep <code class=highlighter-rouge>Y</code> aligned to a word boundary.</p><h2 id=when-default-arrangement-sucks>When default arrangement sucks</h2><p>Default structure arrangement can be problematic at times, especially when dealing with large structures.</p><p>For example, it is often much more readable to group fields together logically, but this can lead to memory memory wastage caused by padding, like in the following simple example:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=n>ReadableButSuboptimal</span>
<span class=p>{</span>
  <span class=n>entity</span><span class=o>*</span> <span class=n>Entities</span><span class=p>;</span>
  <span class=n>u16</span> <span class=n>EntityCount</span><span class=p>;</span>

  <span class=n>mesh</span><span class=o>*</span> <span class=n>Meshes</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>MeshCount</span><span class=p>;</span>

  <span class=n>shader</span><span class=o>*</span> <span class=n>Shaders</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>ShaderCount</span><span class=p>;</span>

  <span class=n>u32</span> <span class=n>Flags</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure><p>This is a perfectly reasonable arrangement for a human: each pointer is followed by the count for the array.</p><p>Unfortunately, it also wastes memory, because of the bytes of padding introduced by the compiler. An optimal, but less readable arrangement would be the following:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=n>LessReadableButOptimal</span>
<span class=p>{</span>
  <span class=n>entity</span><span class=o>*</span> <span class=n>Entities</span><span class=p>;</span>
  <span class=n>mesh</span><span class=o>*</span> <span class=n>Meshes</span><span class=p>;</span>
  <span class=n>shader</span><span class=o>*</span> <span class=n>Shaders</span><span class=p>;</span>

  <span class=n>u16</span> <span class=n>EntityCount</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>MeshCount</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>ShaderCount</span><span class=p>;</span>

  <span class=n>u32</span> <span class=n>Flags</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure><p>This arrangement wastes no bytes in padding, but is, in my opinion, less readable than the previous.</p><h2 id=logical-arrangement-as-an-option>Logical arrangement as an option</h2><p>A better approach for cases like this where the order of members is not important would be to specify structure members logically, for example by decorating the structure like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=n>InAnIdealWorld</span>
<span class=p>{</span>
  <span class=n>entity</span><span class=o>*</span> <span class=n>Entities</span><span class=p>;</span>
  <span class=n>u16</span> <span class=n>EntityCount</span><span class=p>;</span>

  <span class=n>mesh</span><span class=o>*</span> <span class=n>Meshes</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>MeshCount</span><span class=p>;</span>

  <span class=n>shader</span><span class=o>*</span> <span class=n>Shaders</span><span class=p>;</span>
  <span class=n>u8</span> <span class=n>ShaderCount</span><span class=p>;</span>

  <span class=n>u32</span> <span class=n>Flags</span><span class=p>;</span>
<span class=p>}</span> <span class=n>__attribute__</span><span class=p>((</span><span class=n>rearrange</span><span class=p>));</span> <span class=c1>// NOTE: Made up attribute, doesn't actually exist</span></code></pre></figure><p>This would tell the compiler: “Hey, I don’t really care about the order in which the members of this struct are laid out, rearrange them at will”.</p><p>Obviously this shouldn’t be the default behavior as it would cause all sorts of bugs when dealing with structures that have to cross API boundaries between libraries, but it would be very useful for internal subsystems…</p><p>I think ;)</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #47: Logical vs Memory Structure Arrangement&amp;url=https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-47-logical-vs-memory-structure-arrangement/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>