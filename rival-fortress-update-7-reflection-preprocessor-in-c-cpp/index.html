<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Reflection Preprocessor in C/C++ | Metric Panda Games</title><meta name=description content="This past week I’ve been working on a useful engine feature for Rival Fortress: the Reflection Preprocessor.Reflection is usually defined as the ability of a program to examine ..."><meta name=keywords><meta property=og:title content="Reflection Preprocessor in C/C++ | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Reflection Preprocessor in C/C++"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="This past week I’ve been working on a useful engine feature for Rival Fortress: the Reflection Preprocessor.Reflection is usually defined as the ability of a program to examine ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Reflection Preprocessor in C/C++"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Reflection Preprocessor in C/C++</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #7</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>This past week I’ve been working on a useful engine feature for <a href=/rival-fortress/index.html>Rival Fortress</a>: the <em>Reflection Preprocessor</em>.</p><p><a href=https://en.wikipedia.org/wiki/Reflection_(computer_programming)>Reflection</a> is usually defined as the ability of a program to examine itself at runtime. Many programming languages, such as C# and Java, offer built in semantics that make reflection easy. C++ offers a few tools, in the form of <a href=https://en.wikipedia.org/wiki/Run-time_type_information>RTTI</a> and templates, but while working on previous projects I found them to come at a performance cost (in case of RTTI) or a compile time cost (in the case of templates.)</p><p>For Rival Fortress I decided to build on the <a href=/rival-fortress-update-2-preprocessing-and-bundling-game-assets/index.html>asset preprocessor</a> and <a href=/rival-fortress-update-6-opengl-loader/index.html>opengl generator</a> by creating a preprocessor that parses source files looking for annotated sections and generate relevant code.</p><h2 id=the-reflection-preprocessor>The Reflection Preprocessor</h2><p>The preprocessor is a program written in C++ that tokenizes source files looking for code annotated with <code class=highlighter-rouge>MREFLECT(...)</code>. Between the parenthesis are directives that tell the preprocessor what to do with the code that follows.</p><p>The preprocessor runs as part of the build, before anything else, and generates a <code class=highlighter-rouge>Reflection.generated.h</code> that is included by the main headers of each translation unit (I currently only use 2 translation units, one for the game+engine and one for the editor+engine).</p><p>It only runs on files that have been changed since the timestamp of the last generated file, to keep things super fast. On a cold build it can parse roughly 120 files in less than 0.1 seconds, so it adds very little overhead to the build process.</p><h2 id=reflection-for-configuration>Reflection for configuration</h2><p>An example of how I use the preprocessor is to generate configuration reader and writer automatically. The following is an excerpt of the annotated <code class=highlighter-rouge>Config</code> <code class=highlighter-rouge>struct</code> that holds configuration settings that the user can edit:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=n>MREFLECT</span><span class=p>(</span><span class=n>Struct</span><span class=p>)</span>
<span class=k>struct</span> <span class=n>MPEConfig</span>
<span class=p>{</span>
  <span class=kt>char</span><span class=o>*</span> <span class=n>ReadPath</span><span class=p>;</span>
  <span class=kt>char</span><span class=o>*</span> <span class=n>WritePath</span><span class=p>;</span>

  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>Config</span><span class=o>:</span><span class=s>"Engine"</span><span class=p>,</span> <span class=n>Default</span><span class=o>:</span> <span class=n>DEFAULT_MAX_MEMORY</span><span class=p>,</span>
           <span class=nl>Min:</span> <span class=n>MIN_MAX_MEMORY</span><span class=p>,</span> <span class=n>Max</span><span class=o>:</span> <span class=n>MAX_MAX_MEMORY</span><span class=p>,</span>
           <span class=nl>Comment:</span> <span class=n>LOC</span><span class=p>(</span><span class=s>"Max memory that the engine will use"</span><span class=p>)</span>
  <span class=n>u64</span> <span class=n>MaxMemory</span><span class=p>;</span>

  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>Config</span><span class=o>:</span><span class=s>"Engine"</span><span class=p>,</span> <span class=n>Default</span><span class=o>:</span> <span class=n>DEFAULT_FULLSCREEN_MODE</span><span class=p>)</span>
  <span class=n>MPEFullscreenMode</span> <span class=n>FullscreenMode</span><span class=p>;</span>

  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>Config</span><span class=o>:</span><span class=s>"Engine"</span><span class=p>,</span> <span class=n>Default</span><span class=o>:</span> <span class=n>DEFAULT_WINDOW_WIDTH</span><span class=p>,</span>
           <span class=nl>Min:</span> <span class=n>MIN_WINDOW_WIDTH</span><span class=p>)</span>
  <span class=n>i16</span> <span class=n>WindowWidth</span><span class=p>;</span>
  <span class=n>MREFLECT</span><span class=p>(</span><span class=n>Config</span><span class=o>:</span><span class=s>"Engine"</span><span class=p>,</span> <span class=n>Default</span><span class=o>:</span> <span class=n>DEFAULT_WINDOW_HEIGHT</span><span class=p>,</span>
           <span class=nl>Min:</span> <span class=n>MIN_WINDOW_HEIGHT</span><span class=p>)</span>
  <span class=n>i16</span> <span class=n>WindowHeight</span><span class=p>;</span>

  <span class=c1>// Other members below</span>
<span class=p>}</span></code></pre></figure><p>When the reflection preprocessor parses this struct it will automatically generate functions to read/write the config file (in .INI format) with the appropriate parser functions for the types specified and validation for eventual min/max values, as well as default values.</p><p>The relevant tokens are:</p><ul><li><code class=highlighter-rouge>Config</code>: the member should be exposed in the config file under the specified section (in the previous example the section is [Engine])</li><li><code class=highlighter-rouge>Default</code>: the member has a default value</li><li><code class=highlighter-rouge>Min</code>/<code class=highlighter-rouge>Max</code>: the member has a min/max value</li><li><code class=highlighter-rouge>Comment</code>: a localized comment that is placed before the member in the config value</li></ul><p>Member values that are not annotated with <code class=highlighter-rouge>MREFLECT</code> are not written to the configuration file. The preprocessor also keeps track of the struct from witch each member came from and when generating the reader/writer functions adds the appropriate parameters of those types.</p><p>This makes it very easy to quickly expose configuration settings from anywhere in the project.</p><p>This is the output <code class=highlighter-rouge>.ini</code> that gets generated:</p><figure class=highlight><pre><code class=language-ini data-lang=ini><span class=nn>[Engine]</span>
<span class=c>; Max memory that the engine will use
</span><span class=py>MaxMemory</span><span class=p>=</span><span class=s>1073741824</span>
<span class=c>; Allowed values:
; - BorderlessFullscreen
; - Fullscreen
; - Windowed
</span><span class=py>FullscreenMode</span><span class=p>=</span><span class=s>Windowed</span>
<span class=py>WindowWidth</span><span class=p>=</span><span class=s>960</span>
<span class=py>WindowHeight</span><span class=p>=</span><span class=s>600</span></code></pre></figure><p>As you can see the enum <code class=highlighter-rouge>MPEFullscreenMode</code> is treated as a string by stripping redundant prefixes and all possible enum values are prepended to the configuration setting as comments, so the user can easy make changes.</p><h2 id=reflection-for-much-more>Reflection for much more</h2><p>I’m currently adding features to the reflection preprocessor as need arises, and I expect it will become more and more useful as time goes on. For example generating data structures automatically (i.e. Hash tables, resizable arrays) based on types, without having to resort to C++ templates is a plus for me. It keeps compile times super fast, and that’s the way I like it.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #7: Reflection Preprocessor in C/C++&amp;url=https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>