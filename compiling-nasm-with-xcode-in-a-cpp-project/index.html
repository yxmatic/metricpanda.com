<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Compiling NASM Assembly with Xcode in a C/C++ Project | Metric Panda Games</title><meta name=description content="Last time I talked about how to integrate NASM in a CMake/Clang build, but if you are developing on a Mac you may want to use Xcode to debug your assembly code.Xcode needs a bit..."><meta name=keywords><meta property=og:title content="Compiling NASM Assembly with Xcode in a C/C++ Project | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Compiling NASM Assembly with Xcode in a C/C++ Project"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Last time I talked about how to integrate NASM in a CMake/Clang build, but if you are developing on a Mac you may want to use Xcode to debug your assembly code.Xcode needs a bit..."><meta name=twitter:url content="https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/"><meta name=twitter:url content="https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Compiling NASM Assembly with Xcode in a C/C++ Project"><link rel=canonical href="https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Compiling NASM Assembly with Xcode in a C/C++ Project</h1><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/other.html>Other</a></p></header><div class=post-content><p>Last time I talked about how to integrate <a href=/using-nasm-with-cmake-and-clang/index.html>NASM in a CMake/Clang build</a>, but if you are developing on a Mac you may want to use Xcode to debug your assembly code.</p><p>Xcode needs a bit of massaging in order to support NASM within a C/C++ project.</p><h2 id=getting-the-latest-nasm>Getting the latest NASM</h2><p>First I suggest you install the latest version of <a href=http://www.nasm.us>NASM</a> using <a href=http://brew.sh>Homebrew</a> like so:</p><figure class=highlight><pre><code class=language-bash data-lang=bash>brew <span class=nb>install </span>nasm</code></pre></figure><p>This will probably install nasm to <code class=highlighter-rouge>/usr/local/bin</code>, unless you changed your Homebrew config. Double-check the location of your nasm executable and open Xcode.</p><h2 id=sample-c-project>Sample C++ Project</h2><p>I suggest you create a blank “Command Line Tool” project in order to test the integration. You can use this as an test <code class=highlighter-rouge>main.cpp</code>:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=cp>#include &lt;stdio.h&gt;
</span>
<span class=k>extern</span> <span class=s>"C"</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>GetRDTSC</span><span class=p>();</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>**</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>long</span> <span class=kt>long</span> <span class=n>RDTSC1</span> <span class=o>=</span> <span class=n>GetRDTSC</span><span class=p>();</span>
  <span class=kt>long</span> <span class=kt>long</span> <span class=n>RDTSC2</span> <span class=o>=</span> <span class=n>GetRDTSC</span><span class=p>();</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>"Time-Stamp Counters: %lld - %lld</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span> <span class=n>RDTSC1</span><span class=p>,</span> <span class=n>RDTSC2</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>The <code class=highlighter-rouge>GetRDTSC()</code> function returns the <a href=https://en.wikipedia.org/wiki/Time_Stamp_Counter>Time-Stamp Counter</a> and is implemented in Assembly. In <a href=/rival-fortress/index.html>Rival Fortress</a> <code class=highlighter-rouge>rdtsc</code> is used for timing execution of performance critical code.</p><p>Now create a new assembly file. By default Xcode uses the <code class=highlighter-rouge>.s</code> extension for assembly, but I prefer <code class=highlighter-rouge>.asm</code> so I’ll use that in this example. This is the code for the x86-64 assembly file using <a href=http://www.nasm.us/doc/nasmdoc3.html>NASM syntax</a>. The call to <code class=highlighter-rouge>cpuid</code> is required in order to avoid incorrect mesurements coused by <em>Out of Order Execution</em>, as detailed in the <a href=http://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ia-32-ia-64-benchmark-code-execution-paper.pdf>Benchmark Code Execution Paper by Intel</a>.</p><figure class=highlight><pre><code class=language-nasm data-lang=nasm><span class=kr>global</span> <span class=n>_GetRDTSC</span>

<span class=kr>section</span> <span class=p>.</span><span class=n>text</span>

<span class=n>_GetRDTSC</span><span class=o>:</span>
  <span class=k>cpuid</span>
  <span class=k>rdtsc</span>
  <span class=k>shl</span>   <span class=n>rdx</span><span class=p>,</span> <span class=mi>32</span>
  <span class=k>or</span>    <span class=n>rax</span><span class=p>,</span> <span class=n>rdx</span>
  <span class=k>ret</span></code></pre></figure><h2 id=building-nasm-with-xcode>Building NASM with Xcode</h2><p>If you try to build the project you will receive syntax errors from Clang complaining about the invalid tokens from your <code class=highlighter-rouge>.asm</code> file.</p><p>To fix this open the <em>Build Rules</em> for your target and create a new rule like so:</p><div class=post-media></div><p>Here is the build script for easier copying:</p><figure class=highlight><pre><code class=language-bash data-lang=bash>/usr/local/bin/nasm <span class=nt>-f</span> macho64 <span class=k>${</span><span class=nv>INPUT_FILE_PATH</span><span class=k>}</span> <span class=nt>-o</span> <span class=k>${</span><span class=nv>SCRIPT_OUTPUT_FILE_0</span><span class=k>}</span></code></pre></figure><p>And don’t forget to add a new <em>Output File</em> with the following path <code class=highlighter-rouge>$(DERIVED_FILE_DIR)/${INPUT_FILE_BASE}.o</code>.</p><p>Now you should be able to build and debug your project.</p><h2 id=debugging-and-stepping-through-asm-code>Debugging and Stepping through ASM code</h2><p>You can step into your assembly function with Xcode by using <code class=highlighter-rouge>CTRL-F7</code> or <code class=highlighter-rouge>CTRL+click</code>-ing the <em>Step in</em> button in the Xcode GUI.</p><p>The <a href="http://lldb.llvm.org/">LLDB</a> command line is also very useful in order to inspect registers since, unlike Visual Studio, Xcode lacks a <em>Registers window</em>.</p><p>Make sure you have it open by going to <em>View-&gt;Debug Area-&gt;Activate Console</em>, then type LLDB commands in the <code class=highlighter-rouge>(lldb)</code> prompt. Use the <code class=highlighter-rouge>register read</code> command to print out the contents of the general purpose registers in hex, or <code class=highlighter-rouge>print $rax</code> to view the decimal value of a particular register. You can find the <a href=http://lldb.llvm.org/lldb-gdb.html>LLDB Command Map</a> on the official website.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Compiling NASM Assembly with Xcode in a C/C++ Project&amp;url=https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/compiling-nasm-with-xcode-in-a-cpp-project/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>