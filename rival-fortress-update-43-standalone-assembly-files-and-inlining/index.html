<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Standalone Assembly Files And Inlining | Metric Panda Games</title><meta name=description content="Every so often, when the compiler is slacking, I pop the hood and get my hands dirty with assembly.My modus operandi is to write the optimized function in an .asm, assemble it w..."><meta name=keywords><meta property=og:title content="Standalone Assembly Files And Inlining | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Standalone Assembly Files And Inlining"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Every so often, when the compiler is slacking, I pop the hood and get my hands dirty with assembly.My modus operandi is to write the optimized function in an .asm, assemble it w..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Standalone Assembly Files And Inlining"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Standalone Assembly Files And Inlining</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #43</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>Every so often, when the compiler is slacking, I pop the hood and get my hands dirty with assembly.</p><p>My modus operandi is to write the optimized function in an <code class=highlighter-rouge>.asm</code>, assemble it with <a href="http://www.nasm.us/">NASM</a> and add it to the build, along with other <code class=highlighter-rouge>.asm</code> functions, as a static library.</p><p>The problem with this approach is that, to my knowledge, GCC, Clang and MSVC are not able to apply <a href=http://llvm.org/docs/LinkTimeOptimization.html>Link Time Optimization</a> when working with object files that have been compiled from assembly.</p><p>This means that even simple procedures or functions are not inlined, and have to pay the overhead associated with a function call.</p><h2 id=a-simple-example>A simple example</h2><p>Ignoring for a moment the fact that the every compiler exposes a builtin that provides this exact functionality (e.g. <code class=highlighter-rouge>__builtin_ia32_rdtsc()</code>), imagine you needed to add a <a href=https://en.wikipedia.org/wiki/Time_Stamp_Counter>Time Stamp Counter</a> function to your application.</p><p>The following is a dummy application that uses the RDTSC function (the multiply between <code class=highlighter-rouge>GetRDTSC</code> and <code class=highlighter-rouge>argc</code> is there to avoid the compiler optimizing it away):</p><figure class=highlight><pre><code class=language-c data-lang=c><span class=cp>#ifdef __cplusplus
</span><span class=k>extern</span> <span class=s>"C"</span>
<span class=cp>#endif
</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>GetRDTSC</span><span class=p>();</span>

<span class=kt>int</span>
<span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>int</span> <span class=n>Result</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>GetRDTSC</span><span class=p>()</span> <span class=o>*</span> <span class=n>argc</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>Result</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>In order to add the functionality you would have two approaches:</p><ul><li>compile the function as a <strong>standalone assembly</strong> file and add the object file to your build</li><li>use <strong>inline assembly</strong> (if your compiler supports it)</li></ul><h2 id=standalone-assembly>Standalone assembly</h2><p>Standalons assembly works on all compilers and, using <a href=https://en.wikipedia.org/wiki/X86_assembly_language#Syntax>AT&amp;T syntax</a>, looks like this:</p><figure class=highlight><pre><code class=language-assembly data-lang=assembly>.global GetRDTSC

GetRDTSC:
  rdtsc         // read time-stamp counter into EDX:EAX
  shl $32, %rdx // combine into RAX register
  or %rdx, %rax
  ret</code></pre></figure><p>The output produced by GCC and Clang (MSVC produces something similar) when compiled with all optimizations (<code class=highlighter-rouge>-O3 -flto</code>) is:</p><figure class=highlight><pre><code class=language-assembly data-lang=assembly> Dump of assembler code for function main:
   0x00000000004004a0 &lt;+0&gt;:     push   %rbx
   0x00000000004004a1 &lt;+1&gt;:     mov    %edi,%ebx
   0x00000000004004a3 &lt;+3&gt;:     callq  0x400488 &lt;GetRDTSC&gt;
   0x00000000004004a8 &lt;+8&gt;:     imul   %ebx,%eax
   0x00000000004004ab &lt;+11&gt;:    pop    %rbx
   0x00000000004004ac &lt;+12&gt;:    retq</code></pre></figure><p>As you can see, the function has not been inlined, despite begin just three instructions, because (I speculate) the assembler doesn’t decorate the object file with the metadata required by linker in order to optimize the function away when going through <em>link time optimization</em>.</p><h2 id=the-inline-assembly-way>The inline assembly way</h2><p>When using inline assembly, on the other hand, things work as expected, and the resulting binary is optimized correctly.</p><p>This is the inline equivalent of the previous <code class=highlighter-rouge>GetRDTSC</code> function, using the <a href=https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html>GCC Extended Asm</a> syntax:</p><figure class=highlight><pre><code class=language-c data-lang=c><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>long</span>
<span class=nf>GetRDTSC</span><span class=p>()</span>
<span class=p>{</span>
  <span class=c1>// read time-stamp counter into EDX:EAX</span>
  <span class=c1>// then combine into RAX register</span>
  <span class=kt>unsigned</span> <span class=n>Low</span><span class=p>,</span> <span class=n>High</span><span class=p>;</span>
  <span class=n>__asm__</span><span class=p>(</span><span class=s>"rdtsc"</span> <span class=o>:</span> <span class=s>"=a"</span><span class=p>(</span><span class=n>Low</span><span class=p>),</span> <span class=s>"=d"</span> <span class=p>(</span><span class=n>High</span><span class=p>));</span>
  <span class=k>return</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>Low</span><span class=p>)</span> <span class=o>|</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>High</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>);</span>
<span class=p>}</span></code></pre></figure><p>And this is the disassembled <code class=highlighter-rouge>main</code> function:</p><figure class=highlight><pre><code class=language-assembly data-lang=assembly> Dump of assembler code for function main:
   0x00000000004003b0 &lt;+0&gt;:     rdtsc
   0x00000000004003b2 &lt;+2&gt;:     shl    $0x20,%rdx
   0x00000000004003b6 &lt;+6&gt;:     or     %rdx,%rax
   0x00000000004003b9 &lt;+9&gt;:     imul   %edi,%eax
   0x00000000004003bc &lt;+12&gt;:    retq</code></pre></figure><p>Perfect! The function call and associated stack manipulation are gone, and only the essential instructions remain.</p><p>This is the superior approach for compact procedures that are invoked frequently, but can quickly become impossible to maintain as the complexity of the assembly function rises.</p><p>In <a href=/rival-fortress/index.html>Rival Fortress</a> I use a mixture of both approaches: I initially write and debug assembly functions as standalone files, and during profiling sessions I decided if it is worth it to inline them.</p><p><em>NOTE</em>: <em>Inline assembly doesn’t work on MSVC when compiling for x64 targets, so you are out of luck if that is your compiler of choice.</em></p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #43: Standalone Assembly Files And Inlining&amp;url=https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-43-standalone-assembly-files-and-inlining/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>