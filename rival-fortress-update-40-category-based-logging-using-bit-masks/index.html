<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Category-Based Logging Using Bit Masks | Metric Panda Games</title><meta name=description content="Note: You can find the source code for the bit flag logger generator on Github.The logging system I wrote for Metric Panda Engine uses bit masks to support arbitrary composition..."><meta name=keywords><meta property=og:title content="Category-Based Logging Using Bit Masks | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Category-Based Logging Using Bit Masks"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Note: You can find the source code for the bit flag logger generator on Github.The logging system I wrote for Metric Panda Engine uses bit masks to support arbitrary composition..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Category-Based Logging Using Bit Masks"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Category-Based Logging Using Bit Masks</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #40</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p class=note><b>Note</b>: You can find the source code for the bit flag logger generator on <a href=https://github.com/MetricPanda/loggen>Github</a>.</p><p>The logging system I wrote for Metric Panda Engine uses bit masks to support arbitrary composition of logging categories like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp>  <span class=n>Log</span><span class=p>(</span><span class=n>INFO</span><span class=p>,</span> <span class=s>"One"</span><span class=p>);</span>                  <span class=c1>// Outputs: [INFO ][         ][    ] One</span>
  <span class=n>Log</span><span class=p>(</span><span class=n>ERROR</span><span class=o>|</span><span class=n>CATEGORY1</span><span class=p>,</span> <span class=s>"Two"</span><span class=p>);</span>       <span class=c1>// Outputs: [ERROR][CATEGORY1][    ] Two</span>
  <span class=n>Log</span><span class=p>(</span><span class=n>CATEGORY1</span><span class=o>|</span><span class=n>CAT2</span><span class=p>,</span> <span class=s>"Three"</span><span class=p>);</span>      <span class=c1>// Outputs: [     ][CATEGORY1][CAT2] Three</span></code></pre></figure><p>The <code class=highlighter-rouge>Log</code> macro takes a bit mask that is used to filter log messages based on a verbosity mask. The log message, in this case a simple <code class=highlighter-rouge>printf</code>, is prepended with a prefix that is generated from the bit mask.</p><p>Category labels used in the log prefix are resolved at compile time, when building in optimized mode, and the only branch is on the verbosity bit-mask.</p><h2 id=why-bit-masks>Why bit masks</h2><p>Other than the fact that, in my opinion, the API is quite comfortable, using bit masks makes pinpoint filtering much easier.</p><p>For example, in Metric Panda Engine I use three log categories, with labels along these lines:</p><ul><li><strong>Severity</strong>: <code class=highlighter-rouge>VERBOSE</code>, <code class=highlighter-rouge>INFO</code>, <code class=highlighter-rouge>WARN</code>, <code class=highlighter-rouge>ERROR</code></li><li><strong>Subsystem</strong>: <code class=highlighter-rouge>AUDIO</code>, <code class=highlighter-rouge>RENDER</code>, <code class=highlighter-rouge>NET</code>, <code class=highlighter-rouge>INPUT</code>, …</li><li><strong>Subcategory</strong>: <code class=highlighter-rouge>INIT</code>, <code class=highlighter-rouge>SHUTDOWN</code>, <code class=highlighter-rouge>DRAW</code>, <code class=highlighter-rouge>SAMPLE</code>, …</li></ul><p>When investigating a particular subsystem, it is quite easy to filter only events related to it, for example by setting the verbosity mask to <code class=highlighter-rouge>RENDER|INIT</code> messages of any severity coming from the initialization part of the rendering subsystem are shown.</p><h2 id=name-collisions>Name collisions</h2><p>In order to keep category labels short and easy to type, while also avoiding name collisions, the <code class=highlighter-rouge>Log</code> macro looks like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>enum</span>
<span class=p>{</span>
  <span class=n>LOG_VERBOSE</span>        <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span>  <span class=mi>0</span><span class=p>,</span>
  <span class=n>LOG_INFO</span>           <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span>  <span class=mi>1</span><span class=p>,</span>
  <span class=n>LOG_WARN</span>           <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span>  <span class=mi>2</span><span class=p>,</span>
<span class=p>};</span>

<span class=cp>#define Log(Flags, ...) \
{ \
  enum { \
    VERBOSE    = LOG_VERBOSE, \
    INFO       = LOG_INFO, \
    WARN       = LOG_WARN, \
  }; \
  ... \
}</span></code></pre></figure><p>As you can see, the short labels are “aliases” to longer equivalents with the <code class=highlighter-rouge>LOG_</code> prefix. The shorter labels are confined to the scope of the macro so they don’t leak out causing collisions.</p><p>Unfortunately collisions can still occur if macros in the outer scope have the same name as the short labels, like the following example:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define INIT(X) 
</span><span class=c1>// ...</span>
  <span class=n>Log</span><span class=p>(</span><span class=n>INFO</span><span class=o>|</span><span class=n>RENDER</span><span class=o>|</span><span class=n>INIT</span><span class=p>,</span> <span class=s>"Setting up XYZ"</span><span class=p>);</span> <span class=c1>// This won't compile</span></code></pre></figure><p>Fortunately the collision is detected at compile time, so it can be easily fixed by changing the conflicting log label. In Metric Panda Engine I <a href=/rival-fortress-update-38-include-detective-keep-an-eye-on-those-includes/index.html>removed all external includes</a> so I have the luxury of using concise names without fear of collisions.</p><h2 id=filtering-log-entries>Filtering log entries</h2><p>Filtering is done by wrapping the actual logging function in an <code class=highlighter-rouge>if</code> statement like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=cp>#define Log(Flags, ...) \
  ... \
  if ((Flags) &amp; GlobalVerbosity) { \
    DoTheLogging(...); \
  } \
}</span></code></pre></figure><p>The <code class=highlighter-rouge>GlobalVerbosity</code> variable is an integer that can be set to the desired bit mask. Since the <code class=highlighter-rouge>GlobalVerbosity</code> is set outside the macro, the longer version of the log labels are used, like so:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=n>GlobalVerbosity</span><span class=p>;</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>GlobalVerbosity</span> <span class=o>=</span> <span class=n>LOG_INFO</span> <span class=o>|</span> <span class=n>LOG_RENDER</span> <span class=o>|</span> <span class=n>LOG_INIT</span><span class=p>;</span>
  <span class=c1>// ...</span>
<span class=p>}</span></code></pre></figure><h2 id=printing-label-strings>Printing label strings</h2><p>In order to print the labels I’m using simple lookup functions that look like this:</p><figure class=highlight><pre><code class=language-cpp data-lang=cpp><span class=k>static</span> <span class=kr>inline</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=nf>LOG_PrioritiesLabel</span><span class=p>(</span><span class=kt>int</span> <span class=n>Flags</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>Flags</span> <span class=o>&amp;</span> <span class=n>LOG_PRIORITIES_MASK</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>case</span> <span class=n>LOG_VERBOSE</span><span class=p>:</span>     <span class=k>return</span> <span class=s>"[VERBOSE]"</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>LOG_INFO</span><span class=p>:</span>        <span class=k>return</span> <span class=s>"[INFO   ]"</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>LOG_WARN</span><span class=p>:</span>        <span class=k>return</span> <span class=s>"[WARN   ]"</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>LOG_ERROR</span><span class=p>:</span>       <span class=k>return</span> <span class=s>"[ERROR  ]"</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>LOG_FATAL</span><span class=p>:</span>       <span class=k>return</span> <span class=s>"[FATAL  ]"</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=s>"[       ]"</span><span class=p>;</span>
<span class=p>}</span></code></pre></figure><p>As I mentioned earlier, this function is trivially collapsed by the compiler since the <code class=highlighter-rouge>Flags</code> variable is known at compile time, so there is no cost to this approach.</p><p>The <code class=highlighter-rouge>LOG_PRIORITIES_MASK</code> is an integer that masks only the bits that, in this case, make up the priorities labels.</p><h2 id=generating-the-logger-code>Generating the logger code</h2><p>None of the code I showed is written by hand, it is all generated by the <strong>Metareflect</strong> system that <a href=/rival-fortress-update-39-how-i-use-__counter__-to-localize-text-and-hash-strings-at-compile-time/index.html>I talked about</a> in <a href=/rival-fortress-update-7-reflection-preprocessor-in-c-cpp/index.html>previous posts</a>.</p><p>I extracted the relevant bits into a standalone logger generator, <a href=https://github.com/MetricPanda/loggen>loggen</a> that is up on Github.</p><p>Give it a try!</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #40: Category-Based Logging Using Bit Masks&amp;url=https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-40-category-based-logging-using-bit-masks/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>