<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Unpacking and Caching Game Assets At Runtime | Metric Panda Games</title><meta name=description content="I modified the asset subsystem for Rival Fortress to support unpacking of compressed assets at runtime. Things like PNG images and TTF fonts will be converted to “game digestibl..."><meta name=keywords><meta property=og:title content="Unpacking and Caching Game Assets At Runtime | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/"><meta property=og:image content=https://metricpanda.comspring-cleaning.png><meta name=twitter:title content="Unpacking and Caching Game Assets At Runtime"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="I modified the asset subsystem for Rival Fortress to support unpacking of compressed assets at runtime. Things like PNG images and TTF fonts will be converted to “game digestibl..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/"><meta name=twitter:image content=https://metricpanda.comspring-cleaning.png><meta name=twitter:image:alt content="Unpacking and Caching Game Assets At Runtime"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Unpacking and Caching Game Assets At Runtime</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #33</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>I modified the asset subsystem for <a href=/rival-fortress/index.html>Rival Fortress</a> to support unpacking of compressed assets at runtime. Things like PNG images and TTF fonts will be converted to “game digestible” formats at runtime instead of having them preprocessed offline and shipped with the game.</p><p>The reason for this is that I want game content to be easily inspectable and moddable by players without too much trouble.</p><p>Game and user mod content will still be distributed in the <a href=/rival-fortress-update-25-game-mpak-file-format/index.html>MPAK format</a> I talked about a few weeks ago, but the game will come with an <strong>packer/unpacker</strong> executable capable of extracting <code class=highlighter-rouge>.MPAK</code> files and re-compressing them in order to facilitate modding.</p><h2 id=caching-at-runtime>Caching at runtime</h2><p>The first time the game encounters an <code class=highlighter-rouge>.MPAK</code> file, it parses the header looking for assets that need further preprocessing. Assets that are processed are packed into a new <code class=highlighter-rouge>.MPAK</code> file that is saved in the <code class=highlighter-rouge>.cache</code> folder located in the user’s “pref dir” (i.e. the OS specific folder where applications are meant to write user specific files, like save games, preferences, etc.).</p><p>The new <code class=highlighter-rouge>.MPAK</code> file has an internal reference to the parent <code class=highlighter-rouge>.MPAK</code> (there is a 1-to-1 relationship between <code class=highlighter-rouge>.MPAK</code> files) with each entry referencing the original entry. The game keeps an in memory <a href=https://en.wikipedia.org/wiki/B-tree>B-tree</a> containing asset IDs as keys and a pointer to the following data structure as values:</p><figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>struct</span> <span class=n>MPEPakInMemoryEntry</span>
<span class=p>{</span>
  <span class=n>MPEPakFile</span><span class=o>*</span> <span class=n>File</span><span class=p>;</span>
  <span class=kt>void</span><span class=o>*</span> <span class=n>Data</span><span class=p>;</span>
  <span class=n>u64</span> <span class=n>Offset</span><span class=p>;</span>
  <span class=n>u32</span> <span class=n>Size</span><span class=p>;</span>
  <span class=n>MPEPakEntryType</span> <span class=n>Type</span><span class=p>;</span>
  <span class=n>u16</span> <span class=n>Flags</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure><p>The memory representation of the file is updated after the asset has been processed.</p><h2 id=on-demand-processing>On demand processing</h2><p>Not all assets that require processing are processed on load. By default assets are flagged as on-demand (using the <code class=highlighter-rouge>u16 Flags</code> above) and are lazily processed when they are required in a separate processing thread.</p><p>This means that the game treats all asset requests as asynchronous, and falls back to a default object if the asset is not found or not ready.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #33: Unpacking and Caching Game Assets At Runtime&amp;url=https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-33-unpacking-and-caching-game-assets-at-runtime/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>