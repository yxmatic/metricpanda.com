<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Custom memory allocators | Metric Panda Games</title><meta name=description content="This week I’ll briefly talk about the custom memory allocators used in the 3D engine that I’m developing for Rival Fortress.Minimizing system allocator usageC and C++ don’t have..."><meta name=keywords><meta property=og:title content="Custom memory allocators | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Custom memory allocators"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="This week I’ll briefly talk about the custom memory allocators used in the 3D engine that I’m developing for Rival Fortress.Minimizing system allocator usageC and C++ don’t have..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Custom memory allocators"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Custom memory allocators</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #16</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>This week I’ll briefly talk about the custom memory allocators used in the 3D engine that I’m developing for <a href=/rival-fortress/index.html>Rival Fortress</a>.</p><h2 id=minimizing-system-allocator-usage>Minimizing system allocator usage</h2><p>C and C++ don’t have built in garbage collection, so it’s up to the developer to decide how and when to allocate and free memory.</p><p>Relying only on the system allocator by using <code class=highlighter-rouge>new</code> or <code class=highlighter-rouge>malloc</code> for every allocation can cause performance issues, especially when trying to reduce <a href=https://en.wikipedia.org/wiki/CPU_cache#Cache_miss>cache misses</a> and <a href=https://en.wikipedia.org/wiki/Locality_of_reference#Spatial_and_temporal_locality_usage>cache locality</a> as allocations, even back-to-back allocations, are not guaranteed to be close in memory.</p><p>A secondary, but less common, side effect is heap fragmentation: an issue that arises when the system allocator has to periodically waste cycles defragmenting memory because many small allocations and frees have caused the heap to become fragmented.</p><h2 id=custom-allocators>Custom allocators</h2><p>Custom allocators, on the other hand, allow for much finer grained control. They are usually built on top of the system allocator and work by allocating and partitioning larger memory blocks into smaller chunks requested by the application.</p><p>You can find out more about custom allocators in the excellent <a href=http://www.amazon.com/gp/product/1466560010>Game Engine Architecture</a> by Jason Gregory.</p><p>I’m not a big fan of object oriented programming and many of the features C++ has to offer, so most of the allocators that I implemented for the game engine don’t use any C++ fanciness (a part from constructor/destructors used by the <code class=highlighter-rouge>ScopeAllocator</code>). You could certainly implement custom allocators by overloading the <code class=highlighter-rouge>new</code> operator and using <a href=https://en.wikipedia.org/wiki/Placement_syntax>placement new</a> to partition out memory and sprinkling in some templating magic, but that’s not my cup of tea.</p><h2 id=allocators-used-in-rival-fortress>Allocators used in Rival Fortress</h2><p>For Rival Fortress, I allocate a large chunk of memory on start up and partition it to the various subsystems using the following allocators:</p><ul><li><code class=highlighter-rouge>PushAllocator</code>: A simple stack based allocator that, given a block of memory, partitions it out by incrementing a location in a similar manner to how the <a href=https://en.wikipedia.org/wiki/Stack_register>stack pointer</a> works.</li><li><code class=highlighter-rouge>SlidingAllocator</code>: Works on top of a stack allocator and grows until the parent allocator has memory. The characteristic of this allocator is that it can rewind all allocations in order to reset the allocated memory. This is useful as a “one-frame-only” allocator for temporary operations that get wiped at the end of the frame.</li><li><code class=highlighter-rouge>FreeableAllocator</code>: This is one of the few allocators that can reclaim memory and repartition it. It has the capability of merging contiguous free blocks and reallocate existing pointers.</li><li><code class=highlighter-rouge>ScopeAllocator</code>: A temporary allocator that discards any allocations and rewinds the end of the scope.</li><li><code class=highlighter-rouge>ArrayAllocator</code>: Used for growing lists of lists.</li><li><code class=highlighter-rouge>DoubleEndStackAllocator</code>: Similar to the stack allocator, but can grow from both the head or the tail of the memory block.</li><li><code class=highlighter-rouge>ObjectPool</code>: A simple bounded pool of struct that can get recycled by last usage time. This is used in the engine to retire old rendering “chunks” and replace them with new ones without needing to allocate.</li><li><code class=highlighter-rouge>StringPool</code>: A <a href=https://en.wikipedia.org/wiki/String_interning>string interner</a> used for all strings used by the game and engine that allows fast lookups through hashes and string recycling.</li></ul><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #16: Custom memory allocators&amp;url=https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-16-custom-memory-allocators/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>