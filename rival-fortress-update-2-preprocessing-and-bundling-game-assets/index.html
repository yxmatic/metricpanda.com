<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Preprocessing and Bundling Game Assets | Metric Panda Games</title><meta name=description content="Taking a page from the awesome Handmade Hero I decided to pre-process game assets in a format more suitable for game consumption. You can take a look at how Casey approaches it ..."><meta name=keywords><meta property=og:title content="Preprocessing and Bundling Game Assets | Metric Panda Games"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content="https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/"><meta property=og:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:title content="Preprocessing and Bundling Game Assets"><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@MetricPandaGame><meta name=twitter:creator content=@Unspongeful><meta name=twitter:description content="Taking a page from the awesome Handmade Hero I decided to pre-process game assets in a format more suitable for game consumption. You can take a look at how Casey approaches it ..."><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/"><meta name=twitter:url content="https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/"><meta name=twitter:image content=https://metricpanda.commetric-panda-1024x1024.png><meta name=twitter:image:alt content="Preprocessing and Bundling Game Assets"><link rel=canonical href="https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/"><link rel=alternate type=application/rss+xml title="Metric Panda Games" href=https://metricpanda.com/feed.xml><link rel=apple-touch-icon href=apple-icon-precomposed.png><link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href=https://metricpanda.com/favicon.ico><link data-turbolinks-track=reload rel=stylesheet type=text/css href=/assets/metricpanda-39b1a813586a62f5ab272a1dc423ec22fa36f235ccc08b5ec4a21a2c11cc3fe9.css></head><body><header class="header clearfix"><nav class="navbar navbar-custom js-navbar navbar-fixed-top"><div class=container><h3 class=text-muted><a href="/" class=title-backlink><span class=logo-icon><i class="logo-state sprite sprite-small-logo"></i></span><span class=logo-name>MPG</span></a></h3><ul class=nav><li class="nav-link-important nav-link"><a class=nav-action href=/rival-fortress>rival fortress</a></li><li class=nav-separator><i class="icon icon-circle"></i></li><li class=nav-link><a class=nav-action href="/">news</a></li><li class=nav-link><a class=nav-action href=/press.html>press</a></li><li class=nav-link><a data-turbolinks=false class="nav-action js-search-button search-button" href="/">&nbsp;<i class="icon icon-search"></i></a></li></ul></div></nav><section class="masthead js-masthead"><div class=masthead-home><div class=metric-panda-logo><a href="/" class="sprite sprite-logo"></a></div><h1>Metric Panda Games</h1><h2>One pixel at a time.<i></i></h2></div><div class="home-nav clearfix"><ul class="nav nav-pills"><li class=nav-item><span class="nav-block nav-title">News:</span></li><li class=nav-item><a class="nav-block nav-link" href="/">Featured</a></li><li class=nav-item><a class="nav-block nav-link" href="/news/">All</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/rival-fortress.html>Rival Fortress</a></li><li class=nav-item><a class="nav-block nav-link" href=/news/other.html>Other</a></li></ul></div><div><div class="js-masthead-rainbow masthead-rainbow"><i></i></div></div></section></header><section class="js-search-results search-results"><div class="container page-content"><form class="js-search-form search-form"><div class=input-group><input type=text class="form-control js-search-query" placeholder=Search...> <span class=input-group-btn><button class="btn btn-primary" type=submit>Search</button></span></div></form><div class="js-search-results-list search-results-list posts post-list"></div><div class="js-search-results-listing js-search-result-status search-result-status search-result-listing"><button type=button class="btn btn-success js-close-search">Close <i class="icon icon-cancel-1"></i></button></div><div class="js-search-results-loading js-search-result-status search-result-status search-result-loading"><button type=button class="btn btn-info js-close-search">Loading...</button></div><div class="js-search-results-empty js-search-result-status search-result-status search-result-empty"><button type=button class="btn btn-danger js-close-search">No results found <i class="icon icon-cancel-1"></i></button></div></div></section><section class="js-main-content main-content"><article class="page-width post-page container page-content"><header class=post-header><h1 class=post-title>Preprocessing and Bundling Game Assets</h1><p class=game-update><a href=rival-fortress>Rival Fortress Update #2</a></p><p class=post-meta>by <em>Gianni Milanesi</em> <span class=dot>•</span> Category: <a href=/news/rival-fortress.html>Rival Fortress</a></p></header><div class=post-content><p>Taking a page from the awesome <a href="https://handmadehero.org/">Handmade Hero</a> I decided to pre-process game assets in a format more suitable for game consumption. You can take a look at how Casey approaches it starting from <a href=https://hero.handmade.network/episode/game-architecture/day147>Day 150</a> of his series.</p><p><a href=/rival-fortress/index.html>Rival Fortress</a> is a 3D game, so it uses a variety of assets type: textures, normal maps, fonts, meshes, shaders, etc., and each type benefits from a little preprocessing before being used by the actual game engine.</p><p>For this reason I wrote a simple command line tool that reads a <code class=highlighter-rouge>JSON</code> manifest that contains a list of the assets needed by the game, along with some metadata needed by the preprocessor, and spits out a <em>PAK</em> file that the game engine consumes.</p><p>The manifest looks like this:</p><figure class=highlight><pre><code class=language-json data-lang=json><span class=p>[</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"vertexshader"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"shaders/example.vert"</span><span class=p>,</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"fragmentshader"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"shaders/example.frag"</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"geometryshader"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"shaders/example.geom"</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"mesh"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"meshes/cube.obj"</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"mesh"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"meshes/sphere.obj"</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"images/test.jpg"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"texture"</span><span class=w>
  </span><span class=p>},</span><span class=w>
  </span><span class=p>{</span><span class=w>
    </span><span class=s2>"filename"</span><span class=p>:</span><span class=w> </span><span class=s2>"images/test2.tga"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"normalmap"</span><span class=w>
  </span><span class=p>},</span><span class=w>
</span><span class=p>]</span></code></pre></figure><h2 id=the-pak-file-format>The PAK file format</h2><p>The file format I chose is similar to the old <a href=https://en.wikipedia.org/wiki/Quake_(video_game)>Quake</a> PAK: a header, a directory, followed by the asset data.</p><p>The file begins with a header that is laid out like so:</p><pre>
  Header
  (4 bytes) signature = 'MPAK'
  (4 bytes, uint) version number
  (4 bytes, uint) asset count
</pre><p>After that is the directory of assets, that is an array of the following elements:</p><pre>
  Directory entry
  (4 bytes, uint) numerical ID
  (4 bytes, enum) asset type
  (8 bytes, uint64) size in bytes
  (8 bytes, uint64) byte offset within file
</pre><p>The numerical ID of the asset is a 32-bit <a href=https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function>FNV-1</a> hash of the filename of the asset as specified in the <code class=highlighter-rouge>Manifest.json </code> file. The preprocessor also spits out a <code class=highlighter-rouge>.generated.h</code> file, that is included in the build and contains an <code class=highlighter-rouge>enum</code> with all the assets and their ID. With this approach the string hash is computed offline and in no place in the actual game code are assets referred to by their filename, faster lookups by cutting out string comparisons.</p><p>Finally the actual asset data is dependent of the asset type, and contains any metadata related to the asset itself. For example, meshes include the vertex array data as well as <code class=highlighter-rouge>uint</code>s for the number of verts, normals, texcoords and indices.</p><h2 id=preprocessing-shaders>Preprocessing shaders</h2><p>Unfortunately, unlike their DirectX counterparts, OpenGL shaders cannot be precompiled, so all we can do is some basic text manipulation and validation. To do so, the files are squished by removing excess whitespace and comments and compiled with OpenGL to check for syntax errors. The source code is then written into the PAK file.</p><h2 id=preprocessing-images>Preprocessing images</h2><p>Images are loaded into memory as a raw RGB or RGBA byte stream, flipped on the Y axis and written to the PAK file. In a future iteration of the asset preprocessor I’ll likely compress the images with <a href=https://en.wikipedia.org/wiki/S3_Texture_Compression>DXTn</a> as the PAK file is getting kinda bloated with uncompressed images.</p><h2 id=preprocessing-meshes>Preprocessing meshes</h2><p>I chose the <a href=https://en.wikipedia.org/wiki/Wavefront_.obj_file>Wavefront .obj</a> file format for meshes because it is a very simple format. I wrote a simplified parser that can digest only triangulated meshes and has very simple material loading capabilities. I’ll revise it when I’ll get a firmer grip on the rendering requirements for Rival Fortress. Mesh vertex, normal and texture coordinate data is <a href=https://www.opengl.org/wiki/Vertex_Specification#Interleaved_attributes>interleaved</a> into a large float array for better cache locality. This will be used as a single <a href=https://www.opengl.org/wiki/Vertex_Specification#Vertex_Buffer_Object>Vertex Buffer Object (VBO)</a> by OpenGL.</p><h2 id=preprocessing-fonts>Preprocessing fonts</h2><p>I still haven’t tackled font preprocessing, because I’m still unsure as to how I will handle text rendering in the game.</p><aside class="share readable"><span>Share this:</span> <a href="http://twitter.com/share?text=Rival Fortress Update #2: Preprocessing and Bundling Game Assets&amp;url=https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/index.html" class=js-analytics data-target=twitter-share onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i class="icon icon-twitter"></i></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://metricpanda.com/rival-fortress-update-2-preprocessing-and-bundling-game-assets/index.html" class=js-analytics data-target=facebook-share onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i class="icon icon-facebook"></i></a></aside></div><hr class=hr><div class="page-width newsletter-form"><form action=https://tinyletter.com/metricpanda class=js-analytics-form data-target=newsletter-submit method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/metricpanda', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><label for=tlemail><b>Metric Panda Digest</b> <em>(sent monthly and <a data-turbolinks=false class=js-analytics data-target=newsletter-preview href=/newsletters/newsletter-2016-september.html>looks like this</a>)</em></label><div class=input-group><input type=email name=email class=form-control id=tlemail placeholder="Enter your email" required> <input type=hidden value=1 name=embed> <span class=input-group-btn><button class="btn btn-primary" type=submit>Submit</button></span></div><small class=text-muted>We hate spam as much as you do!</small></form></div><hr class=hr></article></section><footer class="site-footer clearfix"><ul class="social js-social"><li><a href=https://github.com/MetricPanda class=js-analytics data-target=github-metricpanda-footer target=_blank><i class="icon icon-github-circled"></i> <b>Github</b></a></li></ul><small>&copy; 2019 Metric Panda Games All rights reserved. <i class="icon icon-star-empty" title=d32745f></i></small><div class=footer-logo><i class="icon icon-metric-panda"></i></div></footer><script data-turbolinks-track=reload data-turbolinks-eval=false type=text/javascript src=/assets/metricpanda-642bfda95fce5f4276f3ac16fa8c8ff98d1d3ef275ab201acce574d9b5d1888f.js></script></body></html>